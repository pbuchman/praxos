name: Copilot Refactoring Pass

on:
  push:
    branches:
      - main

jobs:
  create-refactoring-issue:
    # Only run on PR merges, not direct pushes
    if: github.event.head_commit.message != '' && contains(github.event.head_commit.message, 'Merge pull request')
    runs-on: ubuntu-latest
    environment: copilot
    permissions:
      issues: write
      pull-requests: read
    steps:
      - name: Install Google AI SDK
        run: npm install @google/generative-ai

      - name: Create refactoring issue
        uses: actions/github-script@v7
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          script: |
            const sha = context.sha;
            const shortSha = sha.substring(0, 7);

            // Format date with ordinal suffix (e.g., "22nd of Dec")
            const day = new Date().getDate();
            const suffix = (day > 3 && day < 21) ? 'th' : ['th','st','nd','rd'][day % 10] || 'th';
            const dateStr = `${day}${suffix} of ${new Date().toLocaleString('en-US', { month: 'short' })}`;

            // Extract PR commits and generate summary
            const prMatch = context.payload.head_commit.message.match(/Merge pull request #(\d+)/);
            let polishedSummary = '';

            if (prMatch) {
              const prNumber = parseInt(prMatch[1]);
              console.log(`Found PR #${prNumber}`);

              const { data: commits } = await github.rest.pulls.listCommits({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });

              console.log(`Found ${commits.length} commits`);
              const commitMessages = commits.map(c => c.commit.message.trim()).join('\n\n---\n\n');
              console.log(`Commit messages:\n${commitMessages}`);

              const hasApiKey = !!process.env.GEMINI_API_KEY;
              console.log(`GEMINI_API_KEY present: ${hasApiKey}`);

              if (hasApiKey && commits.length > 0) {
                try {
                  const { GoogleGenerativeAI } = await import('@google/generative-ai');
                  const model = new GoogleGenerativeAI(process.env.GEMINI_API_KEY)
                    .getGenerativeModel({ model: 'gemini-2.0-flash' });

                  const result = await model.generateContent(
                    `Summarize these git commit messages as 1-10 bullet points. Deduplicate and group related changes. Be concise and technical. Output only markdown bullet points, no preamble.\n\nCommit messages:\n${commitMessages}`
                  );
                  const summary = result.response.text()?.trim();
                  console.log(`Gemini response: ${summary}`);
                  if (summary) polishedSummary = `## Changes

            ${summary}`;
                } catch (e) {
                  console.log(`Gemini API error: ${e.message}`);
                  console.log(e.stack);
                }
              }
            } else {
              console.log('No PR number found in commit message');
            }

            const summaryBlock = polishedSummary ? `

            ${polishedSummary}
            ` : '';

            const body = `Execute the refactoring prompt defined in \`.github/prompts/refactoring.prompt.md\`.
            ${summaryBlock}
            ---
            *Commit \`${shortSha}\` Â· PR merge to main*`.replace(/^            /gm, '').trim();

            console.log('--- Issue body ---');
            console.log(body);
            console.log('--- End issue body ---');

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Refactoring pass after merge ${shortSha} (${dateStr})`,
              body,
              labels: ['copilot', 'refactoring', 'automated']
            });

            console.log(`Created issue #${issue.data.number}: ${issue.data.html_url}`);
