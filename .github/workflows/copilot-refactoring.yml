name: Copilot Refactoring Pass

on:
  push:
    branches:
      - main

jobs:
  create-refactoring-issue:
    # Only run on PR merges, not direct pushes
    if: github.event.head_commit.message != '' && contains(github.event.head_commit.message, 'Merge pull request')
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: read
    steps:
      - name: Install Google AI SDK
        run: npm install @google/generative-ai

      - name: Create refactoring issue
        uses: actions/github-script@v7
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          script: |
            const sha = context.sha;
            const shortSha = sha.substring(0, 7);

            // Format date with ordinal suffix (e.g., "22nd of Dec")
            const day = new Date().getDate();
            const suffix = (day > 3 && day < 21) ? 'th' : ['th','st','nd','rd'][day % 10] || 'th';
            const dateStr = `${day}${suffix} of ${new Date().toLocaleString('en-US', { month: 'short' })}`;

            // Extract PR commits and generate summary
            const prMatch = context.payload.head_commit.message.match(/Merge pull request #(\d+)/);
            let commitSummary = '';
            let polishedSummary = '';

            if (prMatch) {
              const { data: commits } = await github.rest.pulls.listCommits({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: parseInt(prMatch[1])
              });

              const commitMessages = commits.map(c => `- ${c.commit.message.split('\n')[0]}`).join('\n');
              commitSummary = `## Commits in this merge\n\n${commitMessages}`;

              if (process.env.GEMINI_API_KEY && commits.length > 0) {
                try {
                  const { GoogleGenerativeAI } = await import('@google/generative-ai');
                  const model = new GoogleGenerativeAI(process.env.GEMINI_API_KEY)
                    .getGenerativeModel({ model: 'gemini-2.0-flash' });

                  const result = await model.generateContent(
                    `Based on these git commit messages from a merged PR, write a brief 2-3 sentence summary of what changed. Be concise and technical.\n\nCommit messages:\n${commitMessages}\n\nSummary:`
                  );
                  const summary = result.response.text()?.trim();
                  if (summary) polishedSummary = `## Summary\n\n${summary}`;
                } catch (e) {
                  console.log(`Gemini API error: ${e.message}`);
                }
              }
            }

            const body = `## Task

            Execute the refactoring prompt defined in \`.github/prompts/refactoring.prompt.md\`.

            **Instructions file:** [\`.github/prompts/refactoring.prompt.md\`](../blob/main/.github/prompts/refactoring.prompt.md)

            ${polishedSummary}

            ${commitSummary}

            ## Refactoring instructions

            1. Scan for code smells
            2. Prioritize by impact
            3. Fix the single most important smell
            4. Document any new patterns found

            ## Trigger

            - **Commit:** ${sha}
            - **Triggered by:** PR merge to main

            ---
            **To start:** Assign this issue to Copilot.
            `;

            console.log('--- Issue body ---');
            console.log(body);
            console.log('--- End issue body ---');

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Refactoring pass after merge ${shortSha} (${dateStr})`,
              body,
              labels: ['copilot', 'refactoring', 'automated']
            });

            console.log(`Created issue #${issue.data.number}: ${issue.data.html_url}`);
