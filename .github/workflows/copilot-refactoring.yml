name: Copilot Refactoring Pass

on:
  push:
    branches:
      - development

jobs:
  create-refactoring-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Create refactoring issue and assign to Copilot
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT }}
        run: |
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"
          SHA="${{ github.sha }}"
          SHORT_SHA="${SHA:0:7}"

          # Get repository ID
          REPO_ID=$(gh api graphql -f query='
            query($owner: String!, $repo: String!) {
              repository(owner: $owner, name: $repo) { id }
            }
          ' -f owner="$OWNER" -f repo="$REPO" --jq '.data.repository.id')

          echo "Repository ID: $REPO_ID"

          # Get Copilot bot ID
          BOT_ID=$(gh api graphql -f query='
            query($owner: String!, $repo: String!) {
              repository(owner: $owner, name: $repo) {
                suggestedActors(capabilities: [CAN_BE_ASSIGNED], first: 10) {
                  nodes { login ... on Bot { id } }
                }
              }
            }
          ' -f owner="$OWNER" -f repo="$REPO" --jq '.data.repository.suggestedActors.nodes[] | select(.login == "copilot-swe-agent") | .id')

          echo "Bot ID: $BOT_ID"

          if [ -z "$BOT_ID" ]; then
            echo "Error: Copilot coding agent not available in this repository"
            exit 1
          fi

          # Create issue and assign to Copilot with Claude Opus model
          RESULT=$(gh api graphql \
            -H 'GraphQL-Features: issues_copilot_assignment_api_support,coding_agent_model_selection' \
            -f query='
              mutation($repoId: ID!, $botId: ID!, $title: String!, $body: String!) {
                createIssue(input: {
                  repositoryId: $repoId
                  title: $title
                  body: $body
                  assigneeIds: [$botId]
                  agentAssignment: {
                    targetRepositoryId: $repoId
                    baseRef: "main"
                    customInstructions: ""
                    customAgent: ""
                    model: "claude-opus-4"
                  }
                }) {
                  issue { number url }
                }
              }
            ' \
            -f repoId="$REPO_ID" \
            -f botId="$BOT_ID" \
            -f title="Refactoring pass after merge $SHORT_SHA" \
            -f body="## Task

          Execute the refactoring prompt defined in \`.github/prompts/refactoring.prompt.md\`.

          **Instructions file:** [\`.github/prompts/refactoring.prompt.md\`](../blob/main/.github/prompts/refactoring.prompt.md)

          The prompt contains all instructions for:
          1. Scanning for code smells
          2. Prioritizing by impact
          3. Fixing the single most important smell
          4. Documenting any new patterns found

          ## Trigger

          - **Commit:** $SHA
          - **Triggered by:** Push to main
          ")

          ISSUE_URL=$(echo "$RESULT" | jq -r '.data.createIssue.issue.url')
          ISSUE_NUM=$(echo "$RESULT" | jq -r '.data.createIssue.issue.number')

          echo "Created issue #$ISSUE_NUM: $ISSUE_URL"
          echo "Assigned to Copilot with Claude Opus model"
