name: Copilot Refactoring Pass

on:
  push:
    branches:
      - main

jobs:
  create-refactoring-issue:
    # Only run on PR merges, not direct pushes
    if: github.event.head_commit.message != '' && contains(github.event.head_commit.message, 'Merge pull request')
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Create refactoring issue
        uses: actions/github-script@v7
        with:
          script: |
            const sha = context.sha;
            const shortSha = sha.substring(0, 7);

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Refactoring pass after merge ${shortSha}`,
              body: `## Task

            Execute the refactoring prompt defined in \`.github/prompts/refactoring.prompt.md\`.

            **Instructions file:** [\`.github/prompts/refactoring.prompt.md\`](../blob/main/.github/prompts/refactoring.prompt.md)

            The prompt contains all instructions for:
            1. Scanning for code smells
            2. Prioritizing by impact
            3. Fixing the single most important smell
            4. Documenting any new patterns found

            ## Trigger

            - **Commit:** ${sha}
            - **Triggered by:** PR merge to main

            ---
            **To start:** Assign this issue to Copilot.
            `,
              labels: ['copilot', 'refactoring', 'automated']
            });

            console.log(`Created issue #${issue.data.number}: ${issue.data.html_url}`);
