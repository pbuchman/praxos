name: Copilot Refactoring Pass

on:
  push:
    branches:
      - main

jobs:
  create-refactoring-issue:
    # Only run on PR merges, not direct pushes
    if: github.event.head_commit.message != '' && contains(github.event.head_commit.message, 'Merge pull request')
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: read
    steps:
      - name: Create refactoring issue
        uses: actions/github-script@v7
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          script: |
            const sha = context.sha;
            const shortSha = sha.substring(0, 7);

            // Format date with ordinal suffix
            const now = new Date();
            const day = now.getDate();
            const ordinal = (d) => {
              if (d > 3 && d < 21) return 'th';
              switch (d % 10) {
                case 1: return 'st';
                case 2: return 'nd';
                case 3: return 'rd';
                default: return 'th';
              }
            };
            const month = now.toLocaleString('en-US', { month: 'short' });
            const dateStr = `${day}${ordinal(day)} of ${month}`;

            // Extract PR number from merge commit message
            const mergeMsg = context.payload.head_commit.message;
            const prMatch = mergeMsg.match(/Merge pull request #(\d+)/);
            let commitSummary = '';
            let polishedSummary = '';

            if (prMatch) {
              const prNumber = parseInt(prMatch[1]);
              console.log(`Found PR #${prNumber}`);

              // Get commits from the PR
              const { data: commits } = await github.rest.pulls.listCommits({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });

              const commitMessages = commits.map(c => `- ${c.commit.message.split('\n')[0]}`).join('\n');
              commitSummary = `## Commits in this merge\n\n${commitMessages}`;
              console.log(`Found ${commits.length} commits`);

              // Use Gemini to polish the summary
              const geminiKey = process.env.GEMINI_API_KEY;
              if (geminiKey && commits.length > 0) {
                try {
                  const prompt = `Based on these git commit messages from a merged PR, write a brief 2-3 sentence summary of what changed. Be concise and technical. Focus on the actual changes, not the process.

            Commit messages:
            ${commitMessages}

            Summary:`;

                  const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=' + geminiKey, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                      contents: [{ parts: [{ text: prompt }] }],
                      generationConfig: { maxOutputTokens: 200 }
                    })
                  });

                  if (response.ok) {
                    const data = await response.json();
                    const summary = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
                    if (summary) {
                      polishedSummary = `## Summary\n\n${summary}`;
                      console.log('Generated summary with Gemini');
                    }
                  }
                } catch (e) {
                  console.log(`Gemini API error: ${e.message}`);
                }
              }
            }

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Refactoring pass after merge ${shortSha} (${dateStr})`,
              body: `## Task

            Execute the refactoring prompt defined in \`.github/prompts/refactoring.prompt.md\`.

            **Instructions file:** [\`.github/prompts/refactoring.prompt.md\`](../blob/main/.github/prompts/refactoring.prompt.md)

            ${polishedSummary}

            ${commitSummary}

            ## Refactoring instructions

            1. Scan for code smells
            2. Prioritize by impact
            3. Fix the single most important smell
            4. Document any new patterns found

            ## Trigger

            - **Commit:** ${sha}
            - **Triggered by:** PR merge to main

            ---
            **To start:** Assign this issue to Copilot.
            `,
              labels: ['copilot', 'refactoring', 'automated']
            });

            console.log(`Created issue #${issue.data.number}: ${issue.data.html_url}`);
