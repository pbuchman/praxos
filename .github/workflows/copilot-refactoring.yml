name: Copilot Refactoring Pass

on:
  push:
    branches:
      - development

jobs:
  create-refactoring-issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Create refactoring issue for Copilot
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Refactoring pass after merge ${context.sha.substring(0, 7)}`,
              body: `## Task

            Execute the refactoring prompt defined in \`.github/prompts/refactoring.prompt.md\`.

            **Instructions file:** [\`.github/prompts/refactoring.prompt.md\`](../blob/main/.github/prompts/refactoring.prompt.md)

            The prompt contains all instructions for:
            1. Scanning for code smells
            2. Prioritizing by impact
            3. Fixing the single most important smell
            4. Documenting any new patterns found

            ## Trigger

            - **Commit:** ${context.sha}
            - **Triggered by:** Push to main
            `,
              labels: ['copilot', 'refactoring', 'automated']
            });

            console.log(`Created issue #${issue.data.number}`);

            // Assign Copilot via agent_assignments endpoint
            // This is the internal GitHub endpoint used by the UI
            const response = await fetch(`https://github.com/${context.repo.owner}/${context.repo.repo}/issues/agent_assignments`, {
              method: 'POST',
              headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                'Authorization': `token ${process.env.GITHUB_TOKEN}`,
              },
              body: JSON.stringify({
                issue_ids: [issue.data.number],
                repo_name_with_owner: `${context.repo.owner}/${context.repo.repo}`,
                base_ref: 'main',
                custom_instructions: '',
                model: 'claude-opus-4.5'
              })
            });

            if (!response.ok) {
              const text = await response.text();
              console.log(`Agent assignment response: ${response.status} - ${text}`);
              // Fallback: the issue is created, user can manually assign Copilot
              console.log(`Issue created: https://github.com/${context.repo.owner}/${context.repo.repo}/issues/${issue.data.number}`);
              console.log('Manual Copilot assignment may be required.');
            } else {
              console.log(`Assigned Copilot to issue #${issue.data.number} with Claude Opus`);
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
