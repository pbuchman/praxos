rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // code_tasks collection (INT-156, INT-364)
    // Design doc: docs/designs/INT-156-code-action-type.md (lines 2083-2120)
    // Owner: code-agent
    // ============================================
    match /code_tasks/{taskId} {
      // code-agent service account: full access
      // This allows the service to create, update, and delete tasks
      allow read, write: if request.auth != null
        && request.auth.token.email == 'code-agent@intexuraos.iam.gserviceaccount.com';

      // Authenticated users: can only read their own tasks
      // Users identify themselves via Auth0 JWT, where request.auth.uid == userId
      allow read: if request.auth != null
        && request.auth.uid == resource.data.userId;

      // Users cannot write directly (must go through code-agent API)
      // This ensures all validation and business logic is enforced
    }

    // ============================================
    // logs subcollection of code_tasks
    // Owner: code-agent
    // ============================================
    match /code_tasks/{taskId}/logs/{logId} {
      // code-agent service account: full access
      allow read, write: if request.auth != null
        && request.auth.token.email == 'code-agent@intexuraos.iam.gserviceaccount.com';

      // Users: can only read logs for their own tasks
      // Must traverse to parent document to check userId
      allow read: if request.auth != null
        && request.auth.uid == get(/databases/$(database)/documents/code_tasks/$(taskId)).data.userId;
    }

    // ============================================
    // user_usage collection (INT-367)
    // Owner: code-agent
    // ============================================
    match /user_usage/{userId} {
      // code-agent service account: full access
      allow read, write: if request.auth != null
        && request.auth.token.email == 'code-agent@intexuraos.iam.gserviceaccount.com';

      // Users: can read their own usage stats
      allow read: if request.auth != null
        && request.auth.uid == userId;
    }

    // ============================================
    // user_spend collection (code-agent)
    // ============================================
    match /user_spend/{userId} {
      // code-agent service account: full access
      allow read, write: if request.auth != null
        && request.auth.token.email == 'code-agent@intexuraos.iam.gserviceaccount.com';

      // Users: can read their own spend data
      allow read: if request.auth != null
        && request.auth.uid == userId;
    }

    // ============================================
    // Existing collections (preserve existing rules)
    // ============================================
    match /_migrations/{docId} {
      allow read: if true;
    }

    match /notion_connections/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
      allow write: if request.auth != null && request.resource.data == null;
    }

    match /promptvault_settings/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    match /whatsapp_messages/{docId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    match /whatsapp_user_mappings/{docId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    match /whatsapp_webhook_events/{docId} {
      allow read: if request.auth != null;
    }

    match /whatsapp_outbound_messages/{docId} {
      allow read: if request.auth != null;
    }

    match /mobile_notifications/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    match /mobile_notification_signatures/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    match /mobile_notifications_filters/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    match /user_settings/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == docId;
    }

    match /auth_tokens/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == docId;
    }

    match /oauth_connections/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    match /researches/{docId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      allow write: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    match /llm_api_logs/{docId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    match /llm_usage_stats/{docId} {
      allow read: if request.auth != null;
    }

    match /commands/{docId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    match /actions/{docId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    match /actions_transitions/{docId} {
      allow read: if request.auth != null;
    }

    match /approval_messages/{docId} {
      allow read: if request.auth != null;
    }

    match /custom_data_sources/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    match /composite_feeds/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    match /composite_feed_snapshots/{docId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    match /generated_images/{docId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    match /notes/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    match /settings/{docId} {
      allow read: if true;
    }

    match /todos/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    match /bookmarks/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    match /visualizations/{docId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    match /calendar_failed_events/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    match /calendar_processed_actions/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    match /calendar_previews/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    match /linear_connections/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    match /linear_failed_issues/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    match /linear_processed_actions/{docId} {
      allow read: if request.auth != null;
    }
  }
}
