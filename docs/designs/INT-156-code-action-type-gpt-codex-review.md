# INT-156 Code Action Type - GPT Codex Review

Sources reviewed: `docs/designs/INT-156-code-action-type.md`, `docs/services/whatsapp-service/technical.md`, `docs/services/commands-agent/technical.md`, `docs/services/actions-agent/technical.md`.

1. Gap: `code` is not part of the current Commands/Actions enums and classification contracts. Reasoning: `commands-agent` only emits `todo`, `research`, `note`, `link`, `calendar`, `linear`, `reminder`, so the new action type cannot be persisted or routed without schema, classifier prompt, and validation updates. Improvement: add `code` to `CommandType`, `ActionType`, classifier prompts/examples, and validation schemas in both services to make the flow executable.
2. Gap: Approval flow for code actions is undefined in the existing WhatsApp and actions-agent pathways. Reasoning: actions-agent approvals today are manual via PATCH or low-confidence logic, and WhatsApp replies like ‚Äúüëç‚Äù will currently be ingested as new commands instead of mapping back to an action. Improvement: include action-specific approval tokens in WhatsApp notifications (interactive buttons or tagged reply IDs), and add explicit approval handling in actions-agent to move `awaiting_approval` ‚Üí `processing` for code actions.
3. Gap: Action lifecycle semantics conflict with ‚Äúhandoff = completed.‚Äù Reasoning: actions-agent currently uses `completed` to mean the work is finished, while code tasks can run for hours after handoff. This will show ‚Äúcompleted‚Äù in inbox while the PR is still pending. Improvement: introduce a dedicated action status (e.g., `dispatched`/`in_progress`) or mirror code-task status into the action document until the PR is delivered.
4. Gap: No durable linkage between actions and code tasks in either direction. Reasoning: the design shows `actionId` in code tasks, but actions-agent does not store `codeTaskId`, and its list UI cannot link to `/code-tasks` or update status. Improvement: persist `codeTaskId` on the action, store `actionId` on the code task, and have code-agent update the action on completion/failure/cancel.
5. Gap: At-least-once Pub/Sub delivery can create duplicate code tasks. Reasoning: actions-agent handlers can be retried, and code-agent dedup is prompt-based, not action-based, so the same action can spawn multiple Linear issues/PRs. Improvement: use a Firestore transactional guard keyed by `actionId`, or pass a deterministic idempotency key so only one code task is created.
6. Gap: Notification ownership is split between actions-agent and code-agent. Reasoning: current system centralizes notifications in actions-agent via WhatsApp pubsub, while the design moves completion notifications into code-agent. This risks duplicate or missing messages. Improvement: define a single owner (recommended: code-agent for code-task outcomes, actions-agent for approval prompts) and document the handoff to avoid double sends.
7. Gap: No reliable queue or retry between code-agent and orchestrator. Reasoning: the design uses a direct HTTP call; if the worker is offline or Cloudflare Access is down, the task fails and the user must retry manually. Improvement: add a persistent dispatch queue (Pub/Sub or Firestore-backed), or allow code-agent to mark tasks as `queued` and retry with backoff until a worker accepts.
8. Gap: Fallback ‚Äúno Linear‚Äù path is invisible to the user and degrades workflow quietly. Reasoning: branch naming, PR templates, and issue tracking differ; users will not know why a PR lacks Linear links. Improvement: surface a clear status flag in the UI/notification and optionally create a lightweight placeholder issue after recovery so tracking remains consistent.
9. Gap: Internal auth between actions-agent ‚Üí code-agent and code-agent ‚Üí orchestrator is not specified. Reasoning: actions-agent uses `X-Internal-Auth` today, but the new services only mention Cloudflare Access and per-task webhook secrets. Improvement: require signed requests or internal auth headers for dispatch endpoints and log failed auth attempts for auditability.
10. Gap: Cost/intent guardrails for code execution are weaker than other action types. Reasoning: code actions are expensive and high-impact, yet the classification rules only rely on verb patterns. Improvement: add a confirmation step that includes a short model-generated plan or cost estimate before approval, and allow quick ‚Äúconvert to Linear issue‚Äù overrides when execution is not desired.
