# IntexuraOS Monolithic Build Pipeline
# Builds and deploys ALL services on every trigger - no conditional logic.

steps:
  # ============================================================================
  # PHASE 1: PARALLEL DOCKER BUILDS (all services)
  # ============================================================================

  # --- user-service ---
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-user-service'
    waitFor: ['-']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        docker buildx create --use --name builder-user-service 2>/dev/null || docker buildx use builder-user-service
        docker buildx build \
          --cache-from=type=registry,ref=${_ARTIFACT_REGISTRY_URL}/user-service:buildcache \
          --cache-to=type=registry,ref=${_ARTIFACT_REGISTRY_URL}/user-service:buildcache,mode=max \
          --push \
          -t ${_ARTIFACT_REGISTRY_URL}/user-service:$COMMIT_SHA \
          -t ${_ARTIFACT_REGISTRY_URL}/user-service:latest \
          -f apps/user-service/Dockerfile .
    env: ['DOCKER_BUILDKIT=1']

  # --- promptvault-service ---
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-promptvault-service'
    waitFor: ['-']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        docker buildx create --use --name builder-promptvault-service 2>/dev/null || docker buildx use builder-promptvault-service
        docker buildx build \
          --cache-from=type=registry,ref=${_ARTIFACT_REGISTRY_URL}/promptvault-service:buildcache \
          --cache-to=type=registry,ref=${_ARTIFACT_REGISTRY_URL}/promptvault-service:buildcache,mode=max \
          --push \
          -t ${_ARTIFACT_REGISTRY_URL}/promptvault-service:$COMMIT_SHA \
          -t ${_ARTIFACT_REGISTRY_URL}/promptvault-service:latest \
          -f apps/promptvault-service/Dockerfile .
    env: ['DOCKER_BUILDKIT=1']

  # --- notion-service ---
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-notion-service'
    waitFor: ['-']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        docker buildx create --use --name builder-notion-service 2>/dev/null || docker buildx use builder-notion-service
        docker buildx build \
          --cache-from=type=registry,ref=${_ARTIFACT_REGISTRY_URL}/notion-service:buildcache \
          --cache-to=type=registry,ref=${_ARTIFACT_REGISTRY_URL}/notion-service:buildcache,mode=max \
          --push \
          -t ${_ARTIFACT_REGISTRY_URL}/notion-service:$COMMIT_SHA \
          -t ${_ARTIFACT_REGISTRY_URL}/notion-service:latest \
          -f apps/notion-service/Dockerfile .
    env: ['DOCKER_BUILDKIT=1']

  # --- whatsapp-service ---
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-whatsapp-service'
    waitFor: ['-']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        docker buildx create --use --name builder-whatsapp-service 2>/dev/null || docker buildx use builder-whatsapp-service
        docker buildx build \
          --cache-from=type=registry,ref=${_ARTIFACT_REGISTRY_URL}/whatsapp-service:buildcache \
          --cache-to=type=registry,ref=${_ARTIFACT_REGISTRY_URL}/whatsapp-service:buildcache,mode=max \
          --push \
          -t ${_ARTIFACT_REGISTRY_URL}/whatsapp-service:$COMMIT_SHA \
          -t ${_ARTIFACT_REGISTRY_URL}/whatsapp-service:latest \
          -f apps/whatsapp-service/Dockerfile .
    env: ['DOCKER_BUILDKIT=1']

  # --- api-docs-hub ---
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-api-docs-hub'
    waitFor: ['-']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        docker buildx create --use --name builder-api-docs-hub 2>/dev/null || docker buildx use builder-api-docs-hub
        docker buildx build \
          --cache-from=type=registry,ref=${_ARTIFACT_REGISTRY_URL}/api-docs-hub:buildcache \
          --cache-to=type=registry,ref=${_ARTIFACT_REGISTRY_URL}/api-docs-hub:buildcache,mode=max \
          --push \
          -t ${_ARTIFACT_REGISTRY_URL}/api-docs-hub:$COMMIT_SHA \
          -t ${_ARTIFACT_REGISTRY_URL}/api-docs-hub:latest \
          -f apps/api-docs-hub/Dockerfile .
    env: ['DOCKER_BUILDKIT=1']

  # --- mobile-notifications-service ---
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-mobile-notifications-service'
    waitFor: ['-']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        docker buildx create --use --name builder-mobile-notifications 2>/dev/null || docker buildx use builder-mobile-notifications
        docker buildx build \
          --cache-from=type=registry,ref=${_ARTIFACT_REGISTRY_URL}/mobile-notifications-service:buildcache \
          --cache-to=type=registry,ref=${_ARTIFACT_REGISTRY_URL}/mobile-notifications-service:buildcache,mode=max \
          --push \
          -t ${_ARTIFACT_REGISTRY_URL}/mobile-notifications-service:$COMMIT_SHA \
          -t ${_ARTIFACT_REGISTRY_URL}/mobile-notifications-service:latest \
          -f apps/mobile-notifications-service/Dockerfile .
    env: ['DOCKER_BUILDKIT=1']

  # --- llm-orchestrator ---
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-llm-orchestrator'
    waitFor: ['-']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        docker buildx create --use --name builder-llm-orchestrator 2>/dev/null || docker buildx use builder-llm-orchestrator
        docker buildx build \
          --cache-from=type=registry,ref=${_ARTIFACT_REGISTRY_URL}/llm-orchestrator:buildcache \
          --cache-to=type=registry,ref=${_ARTIFACT_REGISTRY_URL}/llm-orchestrator:buildcache,mode=max \
          --push \
          -t ${_ARTIFACT_REGISTRY_URL}/llm-orchestrator:$COMMIT_SHA \
          -t ${_ARTIFACT_REGISTRY_URL}/llm-orchestrator:latest \
          -f apps/llm-orchestrator/Dockerfile .
    env: ['DOCKER_BUILDKIT=1']

  # --- commands-router ---
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-commands-router'
    waitFor: ['-']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        docker buildx create --use --name builder-commands-router 2>/dev/null || docker buildx use builder-commands-router
        docker buildx build \
          --cache-from=type=registry,ref=${_ARTIFACT_REGISTRY_URL}/commands-router:buildcache \
          --cache-to=type=registry,ref=${_ARTIFACT_REGISTRY_URL}/commands-router:buildcache,mode=max \
          --push \
          -t ${_ARTIFACT_REGISTRY_URL}/commands-router:$COMMIT_SHA \
          -t ${_ARTIFACT_REGISTRY_URL}/commands-router:latest \
          -f apps/commands-router/Dockerfile .
    env: ['DOCKER_BUILDKIT=1']

  # --- actions-agent ---
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-actions-agent'
    waitFor: ['-']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        docker buildx create --use --name builder-actions-agent 2>/dev/null || docker buildx use builder-actions-agent
        docker buildx build \
          --cache-from=type=registry,ref=${_ARTIFACT_REGISTRY_URL}/actions-agent:buildcache \
          --cache-to=type=registry,ref=${_ARTIFACT_REGISTRY_URL}/actions-agent:buildcache,mode=max \
          --push \
          -t ${_ARTIFACT_REGISTRY_URL}/actions-agent:$COMMIT_SHA \
          -t ${_ARTIFACT_REGISTRY_URL}/actions-agent:latest \
          -f apps/actions-agent/Dockerfile .
    env: ['DOCKER_BUILDKIT=1']

  # --- data-insights-service ---
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-data-insights-service'
    waitFor: ['-']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        docker buildx create --use --name builder-data-insights 2>/dev/null || docker buildx use builder-data-insights
        docker buildx build \
          --cache-from=type=registry,ref=${_ARTIFACT_REGISTRY_URL}/data-insights-service:buildcache \
          --cache-to=type=registry,ref=${_ARTIFACT_REGISTRY_URL}/data-insights-service:buildcache,mode=max \
          --push \
          -t ${_ARTIFACT_REGISTRY_URL}/data-insights-service:$COMMIT_SHA \
          -t ${_ARTIFACT_REGISTRY_URL}/data-insights-service:latest \
          -f apps/data-insights-service/Dockerfile .
    env: ['DOCKER_BUILDKIT=1']

  # --- image-service ---
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-image-service'
    waitFor: ['-']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        docker buildx create --use --name builder-image-service 2>/dev/null || docker buildx use builder-image-service
        docker buildx build \
          --cache-from=type=registry,ref=${_ARTIFACT_REGISTRY_URL}/image-service:buildcache \
          --cache-to=type=registry,ref=${_ARTIFACT_REGISTRY_URL}/image-service:buildcache,mode=max \
          --push \
          -t ${_ARTIFACT_REGISTRY_URL}/image-service:$COMMIT_SHA \
          -t ${_ARTIFACT_REGISTRY_URL}/image-service:latest \
          -f apps/image-service/Dockerfile .
    env: ['DOCKER_BUILDKIT=1']

  # --- notes-agent ---
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-notes-agent'
    waitFor: ['-']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        docker buildx create --use --name builder-notes-agent 2>/dev/null || docker buildx use builder-notes-agent
        docker buildx build \
          --cache-from=type=registry,ref=${_ARTIFACT_REGISTRY_URL}/notes-agent:buildcache \
          --cache-to=type=registry,ref=${_ARTIFACT_REGISTRY_URL}/notes-agent:buildcache,mode=max \
          --push \
          -t ${_ARTIFACT_REGISTRY_URL}/notes-agent:$COMMIT_SHA \
          -t ${_ARTIFACT_REGISTRY_URL}/notes-agent:latest \
          -f apps/notes-agent/Dockerfile .
    env: ['DOCKER_BUILDKIT=1']

  # --- todos-agent ---
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-todos-agent'
    waitFor: ['-']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        docker buildx create --use --name builder-todos-agent 2>/dev/null || docker buildx use builder-todos-agent
        docker buildx build \
          --cache-from=type=registry,ref=${_ARTIFACT_REGISTRY_URL}/todos-agent:buildcache \
          --cache-to=type=registry,ref=${_ARTIFACT_REGISTRY_URL}/todos-agent:buildcache,mode=max \
          --push \
          -t ${_ARTIFACT_REGISTRY_URL}/todos-agent:$COMMIT_SHA \
          -t ${_ARTIFACT_REGISTRY_URL}/todos-agent:latest \
          -f apps/todos-agent/Dockerfile .
    env: ['DOCKER_BUILDKIT=1']

  # --- bookmarks-agent ---
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-bookmarks-agent'
    waitFor: ['-']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        docker buildx create --use --name builder-bookmarks-agent 2>/dev/null || docker buildx use builder-bookmarks-agent
        docker buildx build \
          --cache-from=type=registry,ref=${_ARTIFACT_REGISTRY_URL}/bookmarks-agent:buildcache \
          --cache-to=type=registry,ref=${_ARTIFACT_REGISTRY_URL}/bookmarks-agent:buildcache,mode=max \
          --push \
          -t ${_ARTIFACT_REGISTRY_URL}/bookmarks-agent:$COMMIT_SHA \
          -t ${_ARTIFACT_REGISTRY_URL}/bookmarks-agent:latest \
          -f apps/bookmarks-agent/Dockerfile .
    env: ['DOCKER_BUILDKIT=1']

  # --- app-settings-service ---
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-app-settings-service'
    waitFor: ['-']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        docker buildx create --use --name builder-app-settings 2>/dev/null || docker buildx use builder-app-settings
        docker buildx build \
          --cache-from=type=registry,ref=${_ARTIFACT_REGISTRY_URL}/app-settings-service:buildcache \
          --cache-to=type=registry,ref=${_ARTIFACT_REGISTRY_URL}/app-settings-service:buildcache,mode=max \
          --push \
          -t ${_ARTIFACT_REGISTRY_URL}/app-settings-service:$COMMIT_SHA \
          -t ${_ARTIFACT_REGISTRY_URL}/app-settings-service:latest \
          -f apps/app-settings-service/Dockerfile .
    env: ['DOCKER_BUILDKIT=1']

  # ============================================================================
  # PHASE 1b: WEB BUILD (parallel with Docker builds)
  # ============================================================================

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'fetch-web-secrets'
    waitFor: ['-']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=== Fetching secrets for web ==="
        cat > /workspace/apps/web/.env << EOF
        INTEXURAOS_AUTH0_DOMAIN=$(gcloud secrets versions access latest --secret=INTEXURAOS_AUTH0_DOMAIN)
        INTEXURAOS_AUTH0_SPA_CLIENT_ID=$(gcloud secrets versions access latest --secret=INTEXURAOS_AUTH0_SPA_CLIENT_ID)
        INTEXURAOS_AUTH_AUDIENCE=$(gcloud secrets versions access latest --secret=INTEXURAOS_AUTH_AUDIENCE)
        INTEXURAOS_USER_SERVICE_URL=$(gcloud secrets versions access latest --secret=INTEXURAOS_USER_SERVICE_URL)
        INTEXURAOS_PROMPTVAULT_SERVICE_URL=$(gcloud secrets versions access latest --secret=INTEXURAOS_PROMPTVAULT_SERVICE_URL)
        INTEXURAOS_WHATSAPP_SERVICE_URL=$(gcloud secrets versions access latest --secret=INTEXURAOS_WHATSAPP_SERVICE_URL)
        INTEXURAOS_NOTION_SERVICE_URL=$(gcloud secrets versions access latest --secret=INTEXURAOS_NOTION_SERVICE_URL)
        INTEXURAOS_MOBILE_NOTIFICATIONS_SERVICE_URL=$(gcloud secrets versions access latest --secret=INTEXURAOS_MOBILE_NOTIFICATIONS_SERVICE_URL)
        INTEXURAOS_LLM_ORCHESTRATOR_URL=$(gcloud secrets versions access latest --secret=INTEXURAOS_LLM_ORCHESTRATOR_URL)
        INTEXURAOS_COMMANDS_ROUTER_SERVICE_URL=$(gcloud secrets versions access latest --secret=INTEXURAOS_COMMANDS_ROUTER_SERVICE_URL)
        INTEXURAOS_ACTIONS_AGENT_SERVICE_URL=$(gcloud secrets versions access latest --secret=INTEXURAOS_ACTIONS_AGENT_SERVICE_URL)
        INTEXURAOS_DATA_INSIGHTS_SERVICE_URL=$(gcloud secrets versions access latest --secret=INTEXURAOS_DATA_INSIGHTS_SERVICE_URL)
        INTEXURAOS_NOTES_AGENT_URL=$(gcloud secrets versions access latest --secret=INTEXURAOS_NOTES_AGENT_URL)
        INTEXURAOS_TODOS_AGENT_URL=$(gcloud secrets versions access latest --secret=INTEXURAOS_TODOS_AGENT_URL)
        INTEXURAOS_BOOKMARKS_AGENT_URL=$(gcloud secrets versions access latest --secret=INTEXURAOS_BOOKMARKS_AGENT_URL)
        INTEXURAOS_APP_SETTINGS_SERVICE_URL=$(gcloud secrets versions access latest --secret=INTEXURAOS_APP_SETTINGS_SERVICE_URL)
        INTEXURAOS_FIREBASE_PROJECT_ID=$(gcloud secrets versions access latest --secret=INTEXURAOS_FIREBASE_PROJECT_ID)
        INTEXURAOS_FIREBASE_API_KEY=$(gcloud secrets versions access latest --secret=INTEXURAOS_FIREBASE_API_KEY)
        INTEXURAOS_FIREBASE_AUTH_DOMAIN=$(gcloud secrets versions access latest --secret=INTEXURAOS_FIREBASE_AUTH_DOMAIN)
        EOF
        echo "Secrets written to /workspace/apps/web/.env"

  - name: 'node:22-slim'
    id: 'npm-ci'
    waitFor: ['-']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        apt-get update && apt-get install -y git
        npm ci

  - name: 'node:22-slim'
    id: 'build-web'
    waitFor: ['npm-ci', 'fetch-web-secrets']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        npm run --workspace=@intexuraos/web build
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'

  # ============================================================================
  # PHASE 2: DEPLOYMENTS (each waits for its build)
  # ============================================================================

  # --- Deploy user-service ---
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-user-service'
    waitFor: ['build-user-service']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-user-service.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  # --- Deploy promptvault-service ---
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-promptvault-service'
    waitFor: ['build-promptvault-service']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-promptvault-service.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  # --- Deploy notion-service ---
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-notion-service'
    waitFor: ['build-notion-service']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-notion-service.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  # --- Deploy whatsapp-service ---
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-whatsapp-service'
    waitFor: ['build-whatsapp-service']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-whatsapp-service.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  # --- Deploy api-docs-hub ---
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-api-docs-hub'
    waitFor: ['build-api-docs-hub']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-api-docs-hub.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  # --- Deploy mobile-notifications-service ---
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-mobile-notifications-service'
    waitFor: ['build-mobile-notifications-service']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-mobile-notifications-service.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  # --- Deploy llm-orchestrator ---
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-llm-orchestrator'
    waitFor: ['build-llm-orchestrator']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-llm-orchestrator.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  # --- Deploy commands-router ---
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-commands-router'
    waitFor: ['build-commands-router']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-commands-router.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  # --- Deploy actions-agent ---
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-actions-agent'
    waitFor: ['build-actions-agent']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-actions-agent.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  # --- Deploy data-insights-service ---
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-data-insights-service'
    waitFor: ['build-data-insights-service']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-data-insights-service.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  # --- Deploy image-service ---
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-image-service'
    waitFor: ['build-image-service']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-image-service.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  # --- Deploy notes-agent ---
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-notes-agent'
    waitFor: ['build-notes-agent']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-notes-agent.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  # --- Deploy todos-agent ---
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-todos-agent'
    waitFor: ['build-todos-agent']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-todos-agent.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  # --- Deploy bookmarks-agent ---
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-bookmarks-agent'
    waitFor: ['build-bookmarks-agent']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-bookmarks-agent.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  # --- Deploy app-settings-service ---
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-app-settings-service'
    waitFor: ['build-app-settings-service']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-app-settings-service.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  # --- Deploy web ---
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-web'
    waitFor: ['build-web']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-web.sh']
    env:
      - 'ENVIRONMENT=${_ENVIRONMENT}'
      - 'REGION=${_REGION}'

  # --- Deploy Firestore (migrations) ---
  - name: 'node:22-slim'
    id: 'deploy-firestore'
    waitFor: ['npm-ci']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-firestore.sh']
    env:
      - 'PROJECT_ID=$PROJECT_ID'

# ============================================================================
# OPTIONS
# ============================================================================

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: E2_HIGHCPU_8

timeout: '2400s' # 40 minutes (15 parallel builds + deploys)

substitutions:
  _REGION: europe-central2
  _ARTIFACT_REGISTRY_URL: ''
  _ENVIRONMENT: dev
