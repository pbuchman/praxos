# =============================================================================
# IntexuraOS Cloud Build Configuration
# =============================================================================
#
# ARCHITECTURE: Batched Build-Deploy Pipeline
# ────────────────────────────────────────────
# Services are organized into 6 batches of MAX 3 services each. Each batch
# completes all builds and deploys before the next batch starts. This reduces
# network contention and prevents "unexpected EOF" / "ran out of retries" errors.
#
# Pattern per batch:
#   [build s1..s3 in parallel] → [deploy s1..s3 in parallel] → next batch
#
# BATCH STRUCTURE (max 3 per batch to reduce concurrent pushes):
# ┌─────────────────────────────────────────────────────────────────────────┐
# │ BATCH 1 - Foundation (DB migration + lightweight services)              │
# │   1. deploy-firestore        (migration - runs first)                   │
# │   2. image-service                                                      │
# │   3. api-docs-hub                                                       │
# ├─────────────────────────────────────────────────────────────────────────┤
# │ BATCH 2 - Core Services A                                               │
# │   1. notion-service                                                     │
# │   2. user-service                                                       │
# │   3. whatsapp-service                                                   │
# ├─────────────────────────────────────────────────────────────────────────┤
# │ BATCH 3 - Core Services B                                               │
# │   1. app-settings-service                                               │
# │   2. mobile-notifications-service                                       │
# │   3. research-agent                                                     │
# ├─────────────────────────────────────────────────────────────────────────┤
# │ BATCH 4 - Agents A                                                      │
# │   1. commands-agent                                                     │
# │   2. actions-agent                                                      │
# │   3. data-insights-agent                                                │
# ├─────────────────────────────────────────────────────────────────────────┤
# │ BATCH 5 - Agents B                                                      │
# │   1. notes-agent                                                        │
# │   2. todos-agent                                                        │
# │   3. bookmarks-agent                                                    │
# ├─────────────────────────────────────────────────────────────────────────┤
# │ BATCH 6 - Agents C                                                      │
# │   1. calendar-agent                                                     │
# │   2. linear-agent                                                       │
# │   3. web-agent                                                          │
# ├─────────────────────────────────────────────────────────────────────────┤
# │ BATCH 7 - Code Agent (add new services HERE)                            │
# │   1. code-agent                                                         │
# ├─────────────────────────────────────────────────────────────────────────┤
# │ BATCH 8 - Cloud Functions Workers (parallel with Batch 1-7)             │
# │   1. vm-lifecycle                                                       │
# │   2. log-cleanup                                                        │
# ├─────────────────────────────────────────────────────────────────────────┤
# │ BATCH 9 - Web Frontend                                                  │
# │   1. web (frontend - after all services deployed)                       │
# └─────────────────────────────────────────────────────────────────────────┘
#
# ADDING NEW SERVICES:
#   1. Add to Batch 7 if it has < 3 services
#   2. If Batch 7 is full, create new batch before web frontend
#   3. Update waitFor dependencies accordingly
#
# RETRY LOGIC:
#   build-push-monitored.sh includes 3 retries with 10s delay for docker push
#   to handle transient network failures to Artifact Registry.
#
# =============================================================================

steps:
  # ===========================================================================
  # PREP
  # ===========================================================================
  - name: 'node:22-slim'
    id: 'pnpm-install'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        npm install -g pnpm@10
        pnpm install --frozen-lockfile

  # ===========================================================================
  # BATCH 1 - Foundation (Firestore + 3 lightweight services)
  # ===========================================================================

  # --- Firestore Migration (runs alongside builds) ---
  - name: 'node:22-slim'
    id: 'deploy-firestore'
    waitFor: ['pnpm-install']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        corepack enable
        corepack prepare pnpm@10 --activate
        bash cloudbuild/scripts/deploy-firestore.sh
    env:
      - 'PROJECT_ID=$PROJECT_ID'

  # --- Batch 1 Builds (2 parallel) ---
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-push-image-service'
    waitFor: ['pnpm-install']
    timeout: 900s
    entrypoint: 'bash'
    args:
      [
        'cloudbuild/scripts/build-push-monitored.sh',
        'image-service',
        'apps/image-service/Dockerfile',
      ]
    env:
      - 'DOCKER_BUILDKIT=1'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'COMMIT_SHA=$COMMIT_SHA'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-push-api-docs-hub'
    waitFor: ['pnpm-install']
    timeout: 900s
    entrypoint: 'bash'
    args:
      ['cloudbuild/scripts/build-push-monitored.sh', 'api-docs-hub', 'apps/api-docs-hub/Dockerfile']
    env:
      - 'DOCKER_BUILDKIT=1'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'COMMIT_SHA=$COMMIT_SHA'

  # --- Batch 1 Deploys (wait for builds + firestore) ---
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-image-service'
    waitFor: ['build-push-image-service', 'deploy-firestore']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-image-service.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-api-docs-hub'
    waitFor: ['build-push-api-docs-hub', 'deploy-firestore']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-api-docs-hub.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  # ===========================================================================
  # BATCH 2 - Core Services A (3 services)
  # ===========================================================================

  # --- Batch 2 Builds (wait for Batch 1 deploys) ---
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-push-notion-service'
    waitFor: ['deploy-image-service', 'deploy-api-docs-hub']
    timeout: 900s
    entrypoint: 'bash'
    args:
      [
        'cloudbuild/scripts/build-push-monitored.sh',
        'notion-service',
        'apps/notion-service/Dockerfile',
      ]
    env:
      - 'DOCKER_BUILDKIT=1'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'COMMIT_SHA=$COMMIT_SHA'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-push-user-service'
    waitFor: ['deploy-image-service', 'deploy-api-docs-hub']
    timeout: 900s
    entrypoint: 'bash'
    args:
      ['cloudbuild/scripts/build-push-monitored.sh', 'user-service', 'apps/user-service/Dockerfile']
    env:
      - 'DOCKER_BUILDKIT=1'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'COMMIT_SHA=$COMMIT_SHA'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-push-whatsapp-service'
    waitFor: ['deploy-image-service', 'deploy-api-docs-hub']
    timeout: 900s
    entrypoint: 'bash'
    args:
      [
        'cloudbuild/scripts/build-push-monitored.sh',
        'whatsapp-service',
        'apps/whatsapp-service/Dockerfile',
      ]
    env:
      - 'DOCKER_BUILDKIT=1'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'COMMIT_SHA=$COMMIT_SHA'

  # --- Batch 2 Deploys ---
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-notion-service'
    waitFor: ['build-push-notion-service']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-notion-service.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-user-service'
    waitFor: ['build-push-user-service']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-user-service.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-whatsapp-service'
    waitFor: ['build-push-whatsapp-service']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-whatsapp-service.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  # ===========================================================================
  # BATCH 3 - Core Services B (3 services)
  # ===========================================================================

  # --- Batch 3 Builds (wait for Batch 2 deploys) ---
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-push-app-settings-service'
    waitFor: ['deploy-notion-service', 'deploy-user-service', 'deploy-whatsapp-service']
    timeout: 900s
    entrypoint: 'bash'
    args:
      [
        'cloudbuild/scripts/build-push-monitored.sh',
        'app-settings-service',
        'apps/app-settings-service/Dockerfile',
      ]
    env:
      - 'DOCKER_BUILDKIT=1'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'COMMIT_SHA=$COMMIT_SHA'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-push-mobile-notifications-service'
    waitFor: ['deploy-notion-service', 'deploy-user-service', 'deploy-whatsapp-service']
    timeout: 900s
    entrypoint: 'bash'
    args:
      [
        'cloudbuild/scripts/build-push-monitored.sh',
        'mobile-notifications-service',
        'apps/mobile-notifications-service/Dockerfile',
      ]
    env:
      - 'DOCKER_BUILDKIT=1'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'COMMIT_SHA=$COMMIT_SHA'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-push-research-agent'
    waitFor: ['deploy-notion-service', 'deploy-user-service', 'deploy-whatsapp-service']
    timeout: 900s
    entrypoint: 'bash'
    args:
      [
        'cloudbuild/scripts/build-push-monitored.sh',
        'research-agent',
        'apps/research-agent/Dockerfile',
      ]
    env:
      - 'DOCKER_BUILDKIT=1'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'COMMIT_SHA=$COMMIT_SHA'

  # --- Batch 3 Deploys ---
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-app-settings-service'
    waitFor: ['build-push-app-settings-service']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-app-settings-service.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-mobile-notifications-service'
    waitFor: ['build-push-mobile-notifications-service']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-mobile-notifications-service.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-research-agent'
    waitFor: ['build-push-research-agent']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-research-agent.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  # ===========================================================================
  # BATCH 4 - Agents A (3 services)
  # ===========================================================================

  # --- Batch 4 Builds (wait for Batch 3 deploys) ---
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-push-commands-agent'
    waitFor:
      [
        'deploy-app-settings-service',
        'deploy-mobile-notifications-service',
        'deploy-research-agent',
      ]
    timeout: 900s
    entrypoint: 'bash'
    args:
      [
        'cloudbuild/scripts/build-push-monitored.sh',
        'commands-agent',
        'apps/commands-agent/Dockerfile',
      ]
    env:
      - 'DOCKER_BUILDKIT=1'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'COMMIT_SHA=$COMMIT_SHA'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-push-actions-agent'
    waitFor:
      [
        'deploy-app-settings-service',
        'deploy-mobile-notifications-service',
        'deploy-research-agent',
      ]
    timeout: 900s
    entrypoint: 'bash'
    args:
      [
        'cloudbuild/scripts/build-push-monitored.sh',
        'actions-agent',
        'apps/actions-agent/Dockerfile',
      ]
    env:
      - 'DOCKER_BUILDKIT=1'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'COMMIT_SHA=$COMMIT_SHA'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-push-data-insights-agent'
    waitFor:
      [
        'deploy-app-settings-service',
        'deploy-mobile-notifications-service',
        'deploy-research-agent',
      ]
    timeout: 900s
    entrypoint: 'bash'
    args:
      [
        'cloudbuild/scripts/build-push-monitored.sh',
        'data-insights-agent',
        'apps/data-insights-agent/Dockerfile',
      ]
    env:
      - 'DOCKER_BUILDKIT=1'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'COMMIT_SHA=$COMMIT_SHA'

  # --- Batch 4 Deploys ---
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-commands-agent'
    waitFor: ['build-push-commands-agent']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-commands-agent.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-actions-agent'
    waitFor: ['build-push-actions-agent']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-actions-agent.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-data-insights-agent'
    waitFor: ['build-push-data-insights-agent']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-data-insights-agent.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  # ===========================================================================
  # BATCH 5 - Agents B (3 services)
  # ===========================================================================

  # --- Batch 5 Builds (wait for Batch 4 deploys) ---
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-push-notes-agent'
    waitFor: ['deploy-commands-agent', 'deploy-actions-agent', 'deploy-data-insights-agent']
    timeout: 900s
    entrypoint: 'bash'
    args:
      ['cloudbuild/scripts/build-push-monitored.sh', 'notes-agent', 'apps/notes-agent/Dockerfile']
    env:
      - 'DOCKER_BUILDKIT=1'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'COMMIT_SHA=$COMMIT_SHA'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-push-todos-agent'
    waitFor: ['deploy-commands-agent', 'deploy-actions-agent', 'deploy-data-insights-agent']
    timeout: 900s
    entrypoint: 'bash'
    args:
      ['cloudbuild/scripts/build-push-monitored.sh', 'todos-agent', 'apps/todos-agent/Dockerfile']
    env:
      - 'DOCKER_BUILDKIT=1'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'COMMIT_SHA=$COMMIT_SHA'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-push-bookmarks-agent'
    waitFor: ['deploy-commands-agent', 'deploy-actions-agent', 'deploy-data-insights-agent']
    timeout: 900s
    entrypoint: 'bash'
    args:
      [
        'cloudbuild/scripts/build-push-monitored.sh',
        'bookmarks-agent',
        'apps/bookmarks-agent/Dockerfile',
      ]
    env:
      - 'DOCKER_BUILDKIT=1'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'COMMIT_SHA=$COMMIT_SHA'

  # --- Batch 5 Deploys ---
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-notes-agent'
    waitFor: ['build-push-notes-agent']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-notes-agent.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-todos-agent'
    waitFor: ['build-push-todos-agent']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-todos-agent.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-bookmarks-agent'
    waitFor: ['build-push-bookmarks-agent']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-bookmarks-agent.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  # ===========================================================================
  # BATCH 6 - Agents C (3 services)
  # ===========================================================================

  # --- Batch 6 Builds (wait for Batch 5 deploys) ---
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-push-calendar-agent'
    waitFor: ['deploy-notes-agent', 'deploy-todos-agent', 'deploy-bookmarks-agent']
    timeout: 900s
    entrypoint: 'bash'
    args:
      [
        'cloudbuild/scripts/build-push-monitored.sh',
        'calendar-agent',
        'apps/calendar-agent/Dockerfile',
      ]
    env:
      - 'DOCKER_BUILDKIT=1'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'COMMIT_SHA=$COMMIT_SHA'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-push-linear-agent'
    waitFor: ['deploy-notes-agent', 'deploy-todos-agent', 'deploy-bookmarks-agent']
    timeout: 900s
    entrypoint: 'bash'
    args:
      ['cloudbuild/scripts/build-push-monitored.sh', 'linear-agent', 'apps/linear-agent/Dockerfile']
    env:
      - 'DOCKER_BUILDKIT=1'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'COMMIT_SHA=$COMMIT_SHA'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-push-web-agent'
    waitFor: ['deploy-notes-agent', 'deploy-todos-agent', 'deploy-bookmarks-agent']
    timeout: 900s
    entrypoint: 'bash'
    args: ['cloudbuild/scripts/build-push-monitored.sh', 'web-agent', 'apps/web-agent/Dockerfile']
    env:
      - 'DOCKER_BUILDKIT=1'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'COMMIT_SHA=$COMMIT_SHA'

  # --- Batch 6 Deploys ---
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-calendar-agent'
    waitFor: ['build-push-calendar-agent']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-calendar-agent.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-linear-agent'
    waitFor: ['build-push-linear-agent']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-linear-agent.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-web-agent'
    waitFor: ['build-push-web-agent']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-web-agent.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  # ===========================================================================
  # BATCH 7 - Code Agent (ADD NEW SERVICES HERE, max 3)
  # ===========================================================================

  # --- Batch 7 Builds (wait for Batch 6 deploys) ---
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-push-code-agent'
    waitFor: ['deploy-calendar-agent', 'deploy-linear-agent', 'deploy-web-agent']
    timeout: 900s
    entrypoint: 'bash'
    args: ['cloudbuild/scripts/build-push-monitored.sh', 'code-agent', 'apps/code-agent/Dockerfile']
    env:
      - 'DOCKER_BUILDKIT=1'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'COMMIT_SHA=$COMMIT_SHA'

  # --- Batch 7 Deploys ---
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-code-agent'
    waitFor: ['build-push-code-agent']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-code-agent.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  # ===========================================================================
  # BATCH 8 - Cloud Functions Workers (can run in parallel)
  # ===========================================================================

  # --- Build and deploy vm-lifecycle worker ---
  - name: 'node:22-slim'
    id: 'build-vm-lifecycle'
    waitFor: ['pnpm-install']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        corepack enable
        pnpm --filter @intexuraos/vm-lifecycle build
        # Generate production package.json in dist/
        node -e "
          const fs = require('fs');
          const pkg = JSON.parse(fs.readFileSync('workers/vm-lifecycle/package.json', 'utf-8'));
          const prod = {
            name: pkg.name.replace('@intexuraos/', '') + '-prod',
            version: '1.0.0',
            type: 'module',
            main: 'index.js',
            dependencies: pkg.dependencies || {}
          };
          fs.writeFileSync('workers/vm-lifecycle/dist/package.json', JSON.stringify(prod, null, 2));
        "

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-vm-lifecycle'
    waitFor: ['build-vm-lifecycle']
    entrypoint: 'bash'
    args: ['cloudbuild/scripts/deploy-function.sh', 'vm-lifecycle']
    env:
      - 'REGION=${_REGION}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'
      - 'FUNCTIONS_SOURCE_BUCKET=${_FUNCTIONS_SOURCE_BUCKET}'

  # --- Build and deploy log-cleanup worker ---
  - name: 'node:22-slim'
    id: 'build-log-cleanup'
    waitFor: ['pnpm-install']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        corepack enable
        pnpm --filter @intexuraos/log-cleanup build
        # Generate production package.json in dist/
        node -e "
          const fs = require('fs');
          const pkg = JSON.parse(fs.readFileSync('workers/log-cleanup/package.json', 'utf-8'));
          const prod = {
            name: pkg.name.replace('@intexuraos/', '') + '-prod',
            version: '1.0.0',
            type: 'module',
            main: 'index.js',
            dependencies: pkg.dependencies || {}
          };
          fs.writeFileSync('workers/log-cleanup/dist/package.json', JSON.stringify(prod, null, 2));
        "

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-log-cleanup'
    waitFor: ['build-log-cleanup']
    entrypoint: 'bash'
    args: ['cloudbuild/scripts/deploy-function.sh', 'log-cleanup']
    env:
      - 'REGION=${_REGION}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'
      - 'FUNCTIONS_SOURCE_BUCKET=${_FUNCTIONS_SOURCE_BUCKET}'

  # ===========================================================================
  # BATCH 9 - Web Frontend (after all services deployed)
  # ===========================================================================

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'fetch-web-config'
    waitFor: ['deploy-code-agent', 'deploy-vm-lifecycle', 'deploy-log-cleanup']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=== Fetching config for web ==="
        REGION="${_REGION}"

        # Cloud Run services to fetch URLs for
        CLOUD_RUN_SERVICES=(
          "user-service:USER_SERVICE"
          "whatsapp-service:WHATSAPP_SERVICE"
          "notion-service:NOTION_SERVICE"
          "mobile-notifications-service:MOBILE_NOTIFICATIONS_SERVICE"
          "research-agent:RESEARCH_AGENT"
          "commands-agent:COMMANDS_AGENT"
          "actions-agent:ACTIONS_AGENT"
          "data-insights-agent:DATA_INSIGHTS_AGENT"
          "notes-agent:NOTES_AGENT"
          "todos-agent:TODOS_AGENT"
          "bookmarks-agent:BOOKMARKS_AGENT"
          "calendar-agent:CALENDAR_AGENT"
          "app-settings-service:APP_SETTINGS_SERVICE"
          "linear-agent:LINEAR_AGENT"
          "code-agent:CODE_AGENT"
        )

        # Fetch service URLs
        declare -A SERVICE_URLS
        for entry in "$${CLOUD_RUN_SERVICES[@]}"; do
          SERVICE_NAME="$${entry%%:*}"
          ENV_SUFFIX="$${entry##*:}"
          URL=$$(gcloud run services describe "intexuraos-$${SERVICE_NAME}" --region="$$REGION" --format='value(status.url)')
          SERVICE_URLS["INTEXURAOS_$${ENV_SUFFIX}_URL"]="$$URL"
          echo "  $${ENV_SUFFIX}: $${URL}"
        done

        # Fetch actual secrets
        AUTH0_DOMAIN=$$(gcloud secrets versions access latest --secret=INTEXURAOS_AUTH0_DOMAIN)
        AUTH0_SPA_CLIENT_ID=$$(gcloud secrets versions access latest --secret=INTEXURAOS_AUTH0_SPA_CLIENT_ID)
        AUTH_AUDIENCE=$$(gcloud secrets versions access latest --secret=INTEXURAOS_AUTH_AUDIENCE)
        FIREBASE_PROJECT_ID=$$(gcloud secrets versions access latest --secret=INTEXURAOS_FIREBASE_PROJECT_ID)
        FIREBASE_API_KEY=$$(gcloud secrets versions access latest --secret=INTEXURAOS_FIREBASE_API_KEY)
        FIREBASE_AUTH_DOMAIN=$$(gcloud secrets versions access latest --secret=INTEXURAOS_FIREBASE_AUTH_DOMAIN)
        SENTRY_DSN_WEB=$$(gcloud secrets versions access latest --secret=INTEXURAOS_SENTRY_DSN_WEB)

        # Write .env file
        cat > /workspace/apps/web/.env << EOF
        INTEXURAOS_AUTH0_DOMAIN=$$AUTH0_DOMAIN
        INTEXURAOS_AUTH0_SPA_CLIENT_ID=$$AUTH0_SPA_CLIENT_ID
        INTEXURAOS_AUTH_AUDIENCE=$$AUTH_AUDIENCE
        INTEXURAOS_FIREBASE_PROJECT_ID=$$FIREBASE_PROJECT_ID
        INTEXURAOS_FIREBASE_API_KEY=$$FIREBASE_API_KEY
        INTEXURAOS_FIREBASE_AUTH_DOMAIN=$$FIREBASE_AUTH_DOMAIN
        INTEXURAOS_SENTRY_DSN_WEB=$$SENTRY_DSN_WEB
        INTEXURAOS_ENVIRONMENT=$${_ENVIRONMENT}
        EOF

        # Append service URLs
        for key in "$${!SERVICE_URLS[@]}"; do
          echo "$${key}=$${SERVICE_URLS[$$key]}" >> /workspace/apps/web/.env
        done

        echo "Config written to /workspace/apps/web/.env"

  - name: 'node:22-slim'
    id: 'build-web'
    waitFor: ['pnpm-install', 'fetch-web-config']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=== Building web ==="
        corepack enable
        corepack prepare pnpm@10 --activate
        pnpm run --filter @intexuraos/web build
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-web'
    waitFor: ['build-web']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-web.sh']
    env:
      - 'ENVIRONMENT=${_ENVIRONMENT}'
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: E2_MEDIUM
  env:
    - 'DOCKER_BUILDKIT=1'

substitutions:
  _REGION: europe-central2

timeout: 3600s
