# IntexuraOS Cloud Build Configuration
# Builds and deploys ALL services on every trigger.
# CI checks (lint, typecheck, test) run in GitHub Actions before this.
#
# Optimizations applied:
# - Docker BuildKit with layer caching (--cache-from)
# - Parallel builds for all services (waitFor: ['-'])
# - CLOUD_LOGGING_ONLY for cost savings
#
# Substitutions are provided by the Cloud Build trigger (Terraform):
# - _REGION: GCP region
# - _ARTIFACT_REGISTRY_URL: Full Artifact Registry URL
# - _ENVIRONMENT: Environment name (dev, staging, prod)

steps:
  # Step 1: Install dependencies (needed for web build)
  - name: 'node:22-slim'
    id: 'npm-ci'
    entrypoint: 'npm'
    args: ['ci']

  # ===== PARALLEL SERVICE PIPELINES =====
  # All services build unconditionally when this pipeline runs
  # Build+Push use gcr.io/cloud-builders/docker, Deploy uses cloud-sdk

  # ===== user-service =====
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-push-user-service'
    waitFor: ['-']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=== Building user-service ==="
        docker pull ${_ARTIFACT_REGISTRY_URL}/user-service:latest || true
        docker build \
          --cache-from=${_ARTIFACT_REGISTRY_URL}/user-service:latest \
          --build-arg BUILDKIT_INLINE_CACHE=1 \
          -t ${_ARTIFACT_REGISTRY_URL}/user-service:$COMMIT_SHA \
          -t ${_ARTIFACT_REGISTRY_URL}/user-service:latest \
          -f apps/user-service/Dockerfile .
        docker push ${_ARTIFACT_REGISTRY_URL}/user-service:$COMMIT_SHA
        docker push ${_ARTIFACT_REGISTRY_URL}/user-service:latest
    env:
      - 'DOCKER_BUILDKIT=1'

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-user-service'
    waitFor: ['build-push-user-service']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-user-service.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  # ===== promptvault-service =====
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-push-promptvault-service'
    waitFor: ['-']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=== Building promptvault-service ==="
        docker pull ${_ARTIFACT_REGISTRY_URL}/promptvault-service:latest || true
        docker build \
          --cache-from=${_ARTIFACT_REGISTRY_URL}/promptvault-service:latest \
          --build-arg BUILDKIT_INLINE_CACHE=1 \
          -t ${_ARTIFACT_REGISTRY_URL}/promptvault-service:$COMMIT_SHA \
          -t ${_ARTIFACT_REGISTRY_URL}/promptvault-service:latest \
          -f apps/promptvault-service/Dockerfile .
        docker push ${_ARTIFACT_REGISTRY_URL}/promptvault-service:$COMMIT_SHA
        docker push ${_ARTIFACT_REGISTRY_URL}/promptvault-service:latest
    env:
      - 'DOCKER_BUILDKIT=1'

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-promptvault-service'
    waitFor: ['build-push-promptvault-service']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-promptvault-service.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  # ===== notion-service =====
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-push-notion-service'
    waitFor: ['-']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=== Building notion-service ==="
        docker pull ${_ARTIFACT_REGISTRY_URL}/notion-service:latest || true
        docker build \
          --cache-from=${_ARTIFACT_REGISTRY_URL}/notion-service:latest \
          --build-arg BUILDKIT_INLINE_CACHE=1 \
          -t ${_ARTIFACT_REGISTRY_URL}/notion-service:$COMMIT_SHA \
          -t ${_ARTIFACT_REGISTRY_URL}/notion-service:latest \
          -f apps/notion-service/Dockerfile .
        docker push ${_ARTIFACT_REGISTRY_URL}/notion-service:$COMMIT_SHA
        docker push ${_ARTIFACT_REGISTRY_URL}/notion-service:latest
    env:
      - 'DOCKER_BUILDKIT=1'

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-notion-service'
    waitFor: ['build-push-notion-service']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-notion-service.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  # ===== whatsapp-service =====
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-push-whatsapp-service'
    waitFor: ['-']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=== Building whatsapp-service ==="
        docker pull ${_ARTIFACT_REGISTRY_URL}/whatsapp-service:latest || true
        docker build \
          --cache-from=${_ARTIFACT_REGISTRY_URL}/whatsapp-service:latest \
          --build-arg BUILDKIT_INLINE_CACHE=1 \
          -t ${_ARTIFACT_REGISTRY_URL}/whatsapp-service:$COMMIT_SHA \
          -t ${_ARTIFACT_REGISTRY_URL}/whatsapp-service:latest \
          -f apps/whatsapp-service/Dockerfile .
        docker push ${_ARTIFACT_REGISTRY_URL}/whatsapp-service:$COMMIT_SHA
        docker push ${_ARTIFACT_REGISTRY_URL}/whatsapp-service:latest
    env:
      - 'DOCKER_BUILDKIT=1'

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-whatsapp-service'
    waitFor: ['build-push-whatsapp-service']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-whatsapp-service.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  # ===== api-docs-hub =====
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-push-api-docs-hub'
    waitFor: ['-']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=== Building api-docs-hub ==="
        docker pull ${_ARTIFACT_REGISTRY_URL}/api-docs-hub:latest || true
        docker build \
          --cache-from=${_ARTIFACT_REGISTRY_URL}/api-docs-hub:latest \
          --build-arg BUILDKIT_INLINE_CACHE=1 \
          -t ${_ARTIFACT_REGISTRY_URL}/api-docs-hub:$COMMIT_SHA \
          -t ${_ARTIFACT_REGISTRY_URL}/api-docs-hub:latest \
          -f apps/api-docs-hub/Dockerfile .
        docker push ${_ARTIFACT_REGISTRY_URL}/api-docs-hub:$COMMIT_SHA
        docker push ${_ARTIFACT_REGISTRY_URL}/api-docs-hub:latest
    env:
      - 'DOCKER_BUILDKIT=1'

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-api-docs-hub'
    waitFor: ['build-push-api-docs-hub']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-api-docs-hub.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  # ===== mobile-notifications-service =====
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-push-mobile-notifications-service'
    waitFor: ['-']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=== Building mobile-notifications-service ==="
        docker pull ${_ARTIFACT_REGISTRY_URL}/mobile-notifications-service:latest || true
        docker build \
          --cache-from=${_ARTIFACT_REGISTRY_URL}/mobile-notifications-service:latest \
          --build-arg BUILDKIT_INLINE_CACHE=1 \
          -t ${_ARTIFACT_REGISTRY_URL}/mobile-notifications-service:$COMMIT_SHA \
          -t ${_ARTIFACT_REGISTRY_URL}/mobile-notifications-service:latest \
          -f apps/mobile-notifications-service/Dockerfile .
        docker push ${_ARTIFACT_REGISTRY_URL}/mobile-notifications-service:$COMMIT_SHA
        docker push ${_ARTIFACT_REGISTRY_URL}/mobile-notifications-service:latest
    env:
      - 'DOCKER_BUILDKIT=1'

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-mobile-notifications-service'
    waitFor: ['build-push-mobile-notifications-service']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-mobile-notifications-service.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  # ===== llm-orchestrator =====
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-push-llm-orchestrator'
    waitFor: ['-']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=== Building llm-orchestrator ==="
        docker pull ${_ARTIFACT_REGISTRY_URL}/llm-orchestrator:latest || true
        docker build \
          --cache-from=${_ARTIFACT_REGISTRY_URL}/llm-orchestrator:latest \
          --build-arg BUILDKIT_INLINE_CACHE=1 \
          -t ${_ARTIFACT_REGISTRY_URL}/llm-orchestrator:$COMMIT_SHA \
          -t ${_ARTIFACT_REGISTRY_URL}/llm-orchestrator:latest \
          -f apps/llm-orchestrator/Dockerfile .
        docker push ${_ARTIFACT_REGISTRY_URL}/llm-orchestrator:$COMMIT_SHA
        docker push ${_ARTIFACT_REGISTRY_URL}/llm-orchestrator:latest
    env:
      - 'DOCKER_BUILDKIT=1'

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-llm-orchestrator'
    waitFor: ['build-push-llm-orchestrator']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-llm-orchestrator.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  # ===== commands-router =====
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-push-commands-router'
    waitFor: ['-']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=== Building commands-router ==="
        docker pull ${_ARTIFACT_REGISTRY_URL}/commands-router:latest || true
        docker build \
          --cache-from=${_ARTIFACT_REGISTRY_URL}/commands-router:latest \
          --build-arg BUILDKIT_INLINE_CACHE=1 \
          -t ${_ARTIFACT_REGISTRY_URL}/commands-router:$COMMIT_SHA \
          -t ${_ARTIFACT_REGISTRY_URL}/commands-router:latest \
          -f apps/commands-router/Dockerfile .
        docker push ${_ARTIFACT_REGISTRY_URL}/commands-router:$COMMIT_SHA
        docker push ${_ARTIFACT_REGISTRY_URL}/commands-router:latest
    env:
      - 'DOCKER_BUILDKIT=1'

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-commands-router'
    waitFor: ['build-push-commands-router']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-commands-router.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  # ===== actions-agent =====
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-push-actions-agent'
    waitFor: ['-']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=== Building actions-agent ==="
        docker pull ${_ARTIFACT_REGISTRY_URL}/actions-agent:latest || true
        docker build \
          --cache-from=${_ARTIFACT_REGISTRY_URL}/actions-agent:latest \
          --build-arg BUILDKIT_INLINE_CACHE=1 \
          -t ${_ARTIFACT_REGISTRY_URL}/actions-agent:$COMMIT_SHA \
          -t ${_ARTIFACT_REGISTRY_URL}/actions-agent:latest \
          -f apps/actions-agent/Dockerfile .
        docker push ${_ARTIFACT_REGISTRY_URL}/actions-agent:$COMMIT_SHA
        docker push ${_ARTIFACT_REGISTRY_URL}/actions-agent:latest
    env:
      - 'DOCKER_BUILDKIT=1'

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-actions-agent'
    waitFor: ['build-push-actions-agent']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-actions-agent.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  # ===== data-insights-service =====
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-push-data-insights-service'
    waitFor: ['-']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=== Building data-insights-service ==="
        docker pull ${_ARTIFACT_REGISTRY_URL}/data-insights-service:latest || true
        docker build \
          --cache-from=${_ARTIFACT_REGISTRY_URL}/data-insights-service:latest \
          --build-arg BUILDKIT_INLINE_CACHE=1 \
          -t ${_ARTIFACT_REGISTRY_URL}/data-insights-service:$COMMIT_SHA \
          -t ${_ARTIFACT_REGISTRY_URL}/data-insights-service:latest \
          -f apps/data-insights-service/Dockerfile .
        docker push ${_ARTIFACT_REGISTRY_URL}/data-insights-service:$COMMIT_SHA
        docker push ${_ARTIFACT_REGISTRY_URL}/data-insights-service:latest
    env:
      - 'DOCKER_BUILDKIT=1'

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-data-insights-service'
    waitFor: ['build-push-data-insights-service']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-data-insights-service.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  # ===== image-service =====
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-push-image-service'
    waitFor: ['-']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=== Building image-service ==="
        docker pull ${_ARTIFACT_REGISTRY_URL}/image-service:latest || true
        docker build \
          --cache-from=${_ARTIFACT_REGISTRY_URL}/image-service:latest \
          --build-arg BUILDKIT_INLINE_CACHE=1 \
          -t ${_ARTIFACT_REGISTRY_URL}/image-service:$COMMIT_SHA \
          -t ${_ARTIFACT_REGISTRY_URL}/image-service:latest \
          -f apps/image-service/Dockerfile .
        docker push ${_ARTIFACT_REGISTRY_URL}/image-service:$COMMIT_SHA
        docker push ${_ARTIFACT_REGISTRY_URL}/image-service:latest
    env:
      - 'DOCKER_BUILDKIT=1'

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-image-service'
    waitFor: ['build-push-image-service']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-image-service.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  # ===== notes-agent =====
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-push-notes-agent'
    waitFor: ['-']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=== Building notes-agent ==="
        docker pull ${_ARTIFACT_REGISTRY_URL}/notes-agent:latest || true
        docker build \
          --cache-from=${_ARTIFACT_REGISTRY_URL}/notes-agent:latest \
          --build-arg BUILDKIT_INLINE_CACHE=1 \
          -t ${_ARTIFACT_REGISTRY_URL}/notes-agent:$COMMIT_SHA \
          -t ${_ARTIFACT_REGISTRY_URL}/notes-agent:latest \
          -f apps/notes-agent/Dockerfile .
        docker push ${_ARTIFACT_REGISTRY_URL}/notes-agent:$COMMIT_SHA
        docker push ${_ARTIFACT_REGISTRY_URL}/notes-agent:latest
    env:
      - 'DOCKER_BUILDKIT=1'

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-notes-agent'
    waitFor: ['build-push-notes-agent']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-notes-agent.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  # ===== todos-agent =====
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-push-todos-agent'
    waitFor: ['-']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=== Building todos-agent ==="
        docker pull ${_ARTIFACT_REGISTRY_URL}/todos-agent:latest || true
        docker build \
          --cache-from=${_ARTIFACT_REGISTRY_URL}/todos-agent:latest \
          --build-arg BUILDKIT_INLINE_CACHE=1 \
          -t ${_ARTIFACT_REGISTRY_URL}/todos-agent:$COMMIT_SHA \
          -t ${_ARTIFACT_REGISTRY_URL}/todos-agent:latest \
          -f apps/todos-agent/Dockerfile .
        docker push ${_ARTIFACT_REGISTRY_URL}/todos-agent:$COMMIT_SHA
        docker push ${_ARTIFACT_REGISTRY_URL}/todos-agent:latest
    env:
      - 'DOCKER_BUILDKIT=1'

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-todos-agent'
    waitFor: ['build-push-todos-agent']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-todos-agent.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  # ===== bookmarks-agent =====
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-push-bookmarks-agent'
    waitFor: ['-']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=== Building bookmarks-agent ==="
        docker pull ${_ARTIFACT_REGISTRY_URL}/bookmarks-agent:latest || true
        docker build \
          --cache-from=${_ARTIFACT_REGISTRY_URL}/bookmarks-agent:latest \
          --build-arg BUILDKIT_INLINE_CACHE=1 \
          -t ${_ARTIFACT_REGISTRY_URL}/bookmarks-agent:$COMMIT_SHA \
          -t ${_ARTIFACT_REGISTRY_URL}/bookmarks-agent:latest \
          -f apps/bookmarks-agent/Dockerfile .
        docker push ${_ARTIFACT_REGISTRY_URL}/bookmarks-agent:$COMMIT_SHA
        docker push ${_ARTIFACT_REGISTRY_URL}/bookmarks-agent:latest
    env:
      - 'DOCKER_BUILDKIT=1'

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-bookmarks-agent'
    waitFor: ['build-push-bookmarks-agent']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-bookmarks-agent.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  # ===== app-settings-service =====
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-push-app-settings-service'
    waitFor: ['-']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=== Building app-settings-service ==="
        docker pull ${_ARTIFACT_REGISTRY_URL}/app-settings-service:latest || true
        docker build \
          --cache-from=${_ARTIFACT_REGISTRY_URL}/app-settings-service:latest \
          --build-arg BUILDKIT_INLINE_CACHE=1 \
          -t ${_ARTIFACT_REGISTRY_URL}/app-settings-service:$COMMIT_SHA \
          -t ${_ARTIFACT_REGISTRY_URL}/app-settings-service:latest \
          -f apps/app-settings-service/Dockerfile .
        docker push ${_ARTIFACT_REGISTRY_URL}/app-settings-service:$COMMIT_SHA
        docker push ${_ARTIFACT_REGISTRY_URL}/app-settings-service:latest
    env:
      - 'DOCKER_BUILDKIT=1'

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-app-settings-service'
    waitFor: ['build-push-app-settings-service']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-app-settings-service.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  # ===== calendar-agent =====
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-push-calendar-agent'
    waitFor: ['-']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=== Building calendar-agent ==="
        docker pull ${_ARTIFACT_REGISTRY_URL}/calendar-agent:latest || true
        docker build \
          --cache-from=${_ARTIFACT_REGISTRY_URL}/calendar-agent:latest \
          --build-arg BUILDKIT_INLINE_CACHE=1 \
          -t ${_ARTIFACT_REGISTRY_URL}/calendar-agent:$COMMIT_SHA \
          -t ${_ARTIFACT_REGISTRY_URL}/calendar-agent:latest \
          -f apps/calendar-agent/Dockerfile .
        docker push ${_ARTIFACT_REGISTRY_URL}/calendar-agent:$COMMIT_SHA
        docker push ${_ARTIFACT_REGISTRY_URL}/calendar-agent:latest
    env:
      - 'DOCKER_BUILDKIT=1'

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-calendar-agent'
    waitFor: ['build-push-calendar-agent']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-calendar-agent.sh']
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'
      - 'ENVIRONMENT=${_ENVIRONMENT}'

  # ===== web (static frontend) =====
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'fetch-web-secrets'
    waitFor: ['-']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=== Fetching secrets for web ==="
        cat > /workspace/apps/web/.env << EOF
        INTEXURAOS_AUTH0_DOMAIN=$(gcloud secrets versions access latest --secret=INTEXURAOS_AUTH0_DOMAIN)
        INTEXURAOS_AUTH0_SPA_CLIENT_ID=$(gcloud secrets versions access latest --secret=INTEXURAOS_AUTH0_SPA_CLIENT_ID)
        INTEXURAOS_AUTH_AUDIENCE=$(gcloud secrets versions access latest --secret=INTEXURAOS_AUTH_AUDIENCE)
        INTEXURAOS_USER_SERVICE_URL=$(gcloud secrets versions access latest --secret=INTEXURAOS_USER_SERVICE_URL)
        INTEXURAOS_PROMPTVAULT_SERVICE_URL=$(gcloud secrets versions access latest --secret=INTEXURAOS_PROMPTVAULT_SERVICE_URL)
        INTEXURAOS_WHATSAPP_SERVICE_URL=$(gcloud secrets versions access latest --secret=INTEXURAOS_WHATSAPP_SERVICE_URL)
        INTEXURAOS_NOTION_SERVICE_URL=$(gcloud secrets versions access latest --secret=INTEXURAOS_NOTION_SERVICE_URL)
        INTEXURAOS_MOBILE_NOTIFICATIONS_SERVICE_URL=$(gcloud secrets versions access latest --secret=INTEXURAOS_MOBILE_NOTIFICATIONS_SERVICE_URL)
        INTEXURAOS_LLM_ORCHESTRATOR_URL=$(gcloud secrets versions access latest --secret=INTEXURAOS_LLM_ORCHESTRATOR_URL)
        INTEXURAOS_COMMANDS_ROUTER_SERVICE_URL=$(gcloud secrets versions access latest --secret=INTEXURAOS_COMMANDS_ROUTER_SERVICE_URL)
        INTEXURAOS_ACTIONS_AGENT_SERVICE_URL=$(gcloud secrets versions access latest --secret=INTEXURAOS_ACTIONS_AGENT_SERVICE_URL)
        INTEXURAOS_DATA_INSIGHTS_SERVICE_URL=$(gcloud secrets versions access latest --secret=INTEXURAOS_DATA_INSIGHTS_SERVICE_URL)
        INTEXURAOS_NOTES_AGENT_URL=$(gcloud secrets versions access latest --secret=INTEXURAOS_NOTES_AGENT_URL)
        INTEXURAOS_TODOS_AGENT_URL=$(gcloud secrets versions access latest --secret=INTEXURAOS_TODOS_AGENT_URL)
        INTEXURAOS_BOOKMARKS_AGENT_URL=$(gcloud secrets versions access latest --secret=INTEXURAOS_BOOKMARKS_AGENT_URL)
        INTEXURAOS_APP_SETTINGS_SERVICE_URL=$(gcloud secrets versions access latest --secret=INTEXURAOS_APP_SETTINGS_SERVICE_URL)
        INTEXURAOS_FIREBASE_PROJECT_ID=$(gcloud secrets versions access latest --secret=INTEXURAOS_FIREBASE_PROJECT_ID)
        INTEXURAOS_FIREBASE_API_KEY=$(gcloud secrets versions access latest --secret=INTEXURAOS_FIREBASE_API_KEY)
        INTEXURAOS_FIREBASE_AUTH_DOMAIN=$(gcloud secrets versions access latest --secret=INTEXURAOS_FIREBASE_AUTH_DOMAIN)
        EOF
        echo "Secrets written to /workspace/apps/web/.env"

  - name: 'node:22-slim'
    id: 'build-web'
    waitFor: ['npm-ci', 'fetch-web-secrets']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=== Building web ==="
        npm run --workspace=@intexuraos/web build
    env:
      - 'COMMIT_SHA=$COMMIT_SHA'

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-web'
    waitFor: ['build-web']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-web.sh']
    env:
      - 'ENVIRONMENT=${_ENVIRONMENT}'
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'REGION=${_REGION}'
      - 'ARTIFACT_REGISTRY_URL=${_ARTIFACT_REGISTRY_URL}'

  # ===== firestore (indexes and rules) =====
  - name: 'node:22-slim'
    id: 'deploy-firestore'
    waitFor: ['npm-ci']
    entrypoint: 'bash'
    args: ['-c', 'bash cloudbuild/scripts/deploy-firestore.sh']
    env:
      - 'PROJECT_ID=$PROJECT_ID'

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: E2_HIGHCPU_8
  env:
    - 'DOCKER_BUILDKIT=1'

timeout: 1800s
