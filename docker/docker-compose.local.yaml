services:
  firebase-emulator:
    image: andreysenov/firebase-tools
    ports:
      - '8100:8100'
      - '8101:8101'
      - '8102:8102'
    volumes:
      - ../firebase.json:/home/node/firebase.json:ro
      - ../data/firestore-export:/data/firestore-export:ro
    command: >
      sh -c "if [ -d /data/firestore-export ] && [ -n \"$$(ls -A /data/firestore-export 2>/dev/null)\" ]; then
        echo 'Importing Firestore data from /data/firestore-export...';
        firebase emulators:start --project=demo-intexuraos --import=/data/firestore-export;
      else
        echo 'Starting with empty Firestore...';
        firebase emulators:start --project=demo-intexuraos;
      fi"
    healthcheck:
      test:
        [
          'CMD',
          'node',
          '-e',
          'require("http").get("http://localhost:8100", (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on("error", () => process.exit(1))',
        ]
      interval: 5s
      timeout: 3s
      start_period: 30s
      retries: 10

  fake-gcs:
    image: fsouza/fake-gcs-server
    ports:
      - '8103:8103'
    command: -scheme http -port 8103 -external-url http://localhost:8103
    volumes:
      - gcs-data:/storage
    healthcheck:
      test: ['CMD', 'wget', '--spider', '-q', 'http://localhost:8103/storage/v1/b']
      interval: 5s
      timeout: 3s
      start_period: 10s
      retries: 5

  pubsub-ui:
    build:
      context: ../tools/pubsub-ui
      dockerfile: Dockerfile
    ports:
      - '8105:8105'
    environment:
      - PUBSUB_EMULATOR_HOST=firebase-emulator:8102
      - PUBSUB_PROJECT_ID=demo-intexuraos
      - PORT=8105
      - INTEXURAOS_INTERNAL_AUTH_TOKEN=local-dev-token
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    depends_on:
      firebase-emulator:
        condition: service_healthy

volumes:
  gcs-data:
