{"ts":"2026-01-26T22:11:18.015Z","project":"intexuraos-1","branch":"kontakt/int-367-tier-1-user-rate-limiting-infrastructure-user_usage","runNumber":1,"passed":false,"durationMs":56570,"failureCount":25,"failures":[{"type":"typecheck","code":"TS6133","file":"apps/code-agent/src/__tests__/helpers/mockServices.ts","line":15,"message":"'createUserUsageFirestoreRepository' is declared but its value is never read.","snippet":"import { createUserUsageFirestoreRepository } from '../../infra/firestore/userUsageFirestoreRepository.js';","context":" 13: import { createWhatsAppNotifier } from '../../infra/services/whatsappNotifierImpl.js';\n 14: import { createActionsAgentClient } from '../../infra/clients/actionsAgentClient.js';\n>15: import { createUserUsageFirestoreRepository } from '../../infra/firestore/userUsageFirestoreRepository.js';\n 16: import { createRateLimitService } from '../../domain/services/rateLimitService.js';\n 17: import type { RateLimitService } from '../../domain/services/rateLimitService.js';"},{"type":"typecheck","code":"TS6133","file":"apps/code-agent/src/__tests__/helpers/mockServices.ts","line":16,"message":"'createRateLimitService' is declared but its value is never read.","snippet":"import { createRateLimitService } from '../../domain/services/rateLimitService.js';","context":" 14: import { createActionsAgentClient } from '../../infra/clients/actionsAgentClient.js';\n 15: import { createUserUsageFirestoreRepository } from '../../infra/firestore/userUsageFirestoreRepository.js';\n>16: import { createRateLimitService } from '../../domain/services/rateLimitService.js';\n 17: import type { RateLimitService } from '../../domain/services/rateLimitService.js';\n 18: import { ok } from '@intexuraos/common-core';"},{"type":"typecheck","code":"TS2345","file":"apps/code-agent/src/__tests__/openapi-contract.test.ts","line":50,"message":"Argument of type '{ firestore: Firestore; logger: Logger; codeTaskRepo: CodeTaskRepository; workerDiscovery: WorkerDiscoveryService; taskDispatcher: TaskDispatcherService; logChunkRepo: LogChunkRepository; actionsAgentClient: ActionsAgentClient; whatsappNotifier: WhatsAppNotifier; }' is not assignable to parameter of type 'ServiceContainer'.","snippet":"setServices({","context":" 48:     const logger = pino({ name: 'test' }) as unknown as Logger;\n 49: \n>50:     setServices({\n 51:       firestore: fakeFirestore,\n 52:       logger,"},{"type":"typecheck","code":"TS2345","file":"apps/code-agent/src/__tests__/routes/codeProcess.test.ts","line":97,"message":"Argument of type '{ firestore: Firestore; logger: Logger; codeTaskRepo: CodeTaskRepository; taskDispatcher: TaskDispatcherService; workerDiscovery: WorkerDiscoveryService; logChunkRepo: LogChunkRepository; actionsAgentClient: ActionsAgentClient; whatsappNotifier: WhatsAppNotifier; }' is not assignable to parameter of type 'ServiceContainer'.","snippet":"setServices({","context":" 95:     });\n 96: \n>97:     setServices({\n 98:       firestore: fakeFirestore as unknown as Firestore,\n 99:       logger,"},{"type":"typecheck","code":"TS2345","file":"apps/code-agent/src/__tests__/routes/codeTasks.test.ts","line":96,"message":"Argument of type '{ firestore: Firestore; logger: Logger; codeTaskRepo: CodeTaskRepository; workerDiscovery: WorkerDiscoveryService; taskDispatcher: TaskDispatcherService; logChunkRepo: LogChunkRepository; actionsAgentClient: ActionsAgentClient; whatsappNotifier: WhatsAppNotifier; }' is not assignable to parameter of type 'ServiceContainer'.","snippet":"setServices({","context":" 94:     });\n 95: \n>96:     setServices({\n 97:       firestore: fakeFirestore as unknown as Firestore,\n 98:       logger,"},{"type":"typecheck","code":"TS2345","file":"apps/code-agent/src/__tests__/routes/webhooks.test.ts","line":108,"message":"Argument of type '{ firestore: Firestore; logger: pino.Logger; codeTaskRepo: CodeTaskRepository; logChunkRepo: LogChunkRepository; workerDiscovery: WorkerDiscoveryService; taskDispatcher: TaskDispatcherService; whatsappNotifier: WhatsAppNotifier; actionsAgentClient: ActionsAgentClient; }' is not assignable to parameter of type 'ServiceContainer'.","snippet":"setServices({","context":" 106:     mockFetchWithAuth.mockResolvedValue(ok(undefined));\n 107: \n>108:     setServices({\n 109:       firestore: fakeFirestore as unknown as Firestore,\n 110:       logger,"},{"type":"typecheck","code":"TS2345","file":"apps/code-agent/src/__tests__/routes/webhooks.test.ts","line":1214,"message":"Argument of type '{ firestore: Firestore; logger: Logger; codeTaskRepo: CodeTaskRepository; logChunkRepo: LogChunkRepository; workerDiscovery: WorkerDiscoveryService; taskDispatcher: TaskDispatcherService; actionsAgentClient: ActionsAgentClient; whatsappNotifier: WhatsAppNotifier; }' is not assignable to parameter of type 'ServiceContainer'.","snippet":"setServices({","context":" 1212:     });\n 1213: \n>1214:     setServices({\n 1215:       firestore: fakeFirestore as unknown as Firestore,\n 1216:       logger,"},{"type":"typecheck","code":"TS2345","file":"apps/code-agent/src/__tests__/routes/webhooks.test.ts","line":1491,"message":"Argument of type '{ firestore: Firestore; logger: pino.Logger; codeTaskRepo: CodeTaskRepository; logChunkRepo: LogChunkRepository; workerDiscovery: WorkerDiscoveryService; taskDispatcher: TaskDispatcherService; whatsappNotifier: WhatsAppNotifier; actionsAgentClient: ActionsAgentClient; }' is not assignable to parameter of type 'ServiceContainer'.","snippet":"setServices({","context":" 1489:     mockFetchWithAuth.mockResolvedValue(ok(undefined));\n 1490: \n>1491:     setServices({\n 1492:       firestore: fakeFirestore as unknown as Firestore,\n 1493:       logger,"},{"type":"typecheck","code":"TS4111","file":"apps/code-agent/src/infra/firestore/userUsageFirestoreRepository.ts","line":27,"message":"Property 'toDate' comes from an index signature, so it must be accessed with ['toDate'].","snippet":"if ('toDate' in obj && typeof obj.toDate === 'function') {","context":" 25:   if (typeof value === 'object' && value !== null) {\n 26:     const obj = value as Record<string, unknown>;\n>27:     if ('toDate' in obj && typeof obj.toDate === 'function') {\n 28:       return obj as Timestamp;\n 29:     }"},{"type":"typecheck","code":"TS2352","file":"apps/code-agent/src/infra/firestore/userUsageFirestoreRepository.ts","line":28,"message":"Conversion of type 'Record<string, unknown>' to type 'Timestamp' may be a mistake because neither type sufficiently overlaps with the other. If this was intentional, convert the expression to 'unknown' first.","snippet":"return obj as Timestamp;","context":" 26:     const obj = value as Record<string, unknown>;\n 27:     if ('toDate' in obj && typeof obj.toDate === 'function') {\n>28:       return obj as Timestamp;\n 29:     }\n 30:     if ('_seconds' in obj && typeof obj._seconds === 'number') {"},{"type":"typecheck","code":"TS4111","file":"apps/code-agent/src/infra/firestore/userUsageFirestoreRepository.ts","line":30,"message":"Property '_seconds' comes from an index signature, so it must be accessed with ['_seconds'].","snippet":"if ('_seconds' in obj && typeof obj._seconds === 'number') {","context":" 28:       return obj as Timestamp;\n 29:     }\n>30:     if ('_seconds' in obj && typeof obj._seconds === 'number') {\n 31:       const seconds = obj._seconds as number;\n 32:       const nanos = (obj._nanoseconds as number) ?? 0;"},{"type":"typecheck","code":"TS4111","file":"apps/code-agent/src/infra/firestore/userUsageFirestoreRepository.ts","line":31,"message":"Property '_seconds' comes from an index signature, so it must be accessed with ['_seconds'].","snippet":"const seconds = obj._seconds as number;","context":" 29:     }\n 30:     if ('_seconds' in obj && typeof obj._seconds === 'number') {\n>31:       const seconds = obj._seconds as number;\n 32:       const nanos = (obj._nanoseconds as number) ?? 0;\n 33:       return new Timestamp(seconds, nanos);"},{"type":"typecheck","code":"TS4111","file":"apps/code-agent/src/infra/firestore/userUsageFirestoreRepository.ts","line":32,"message":"Property '_nanoseconds' comes from an index signature, so it must be accessed with ['_nanoseconds'].","snippet":"const nanos = (obj._nanoseconds as number) ?? 0;","context":" 30:     if ('_seconds' in obj && typeof obj._seconds === 'number') {\n 31:       const seconds = obj._seconds as number;\n>32:       const nanos = (obj._nanoseconds as number) ?? 0;\n 33:       return new Timestamp(seconds, nanos);\n 34:     }"},{"type":"typecheck","code":"TS6133","file":"apps/code-agent/src/infra/firestore/userUsageFirestoreRepository.ts","line":42,"message":"'logger' is declared but its value is never read.","snippet":"logger: Logger","context":" 40: export function createUserUsageFirestoreRepository(\n 41:   firestore: Firestore,\n>42:   logger: Logger\n 43: ): UserUsageRepository {\n 44:   function createDefaultUsage(userId: string, now: Timestamp): UserUsage {"},{"type":"typecheck","code":"TS4111","file":"apps/code-agent/src/infra/firestore/userUsageFirestoreRepository.ts","line":88,"message":"Property 'userId' comes from an index signature, so it must be accessed with ['userId'].","snippet":"userId: String(data.userId),","context":" 86:   function normalizeUsage(data: Record<string, unknown>): UserUsage {\n 87:     return {\n>88:       userId: String(data.userId),\n 89:       concurrentTasks: Number(data.concurrentTasks ?? 0),\n 90:       tasksThisHour: Number(data.tasksThisHour ?? 0),"},{"type":"typecheck","code":"TS4111","file":"apps/code-agent/src/infra/firestore/userUsageFirestoreRepository.ts","line":89,"message":"Property 'concurrentTasks' comes from an index signature, so it must be accessed with ['concurrentTasks'].","snippet":"concurrentTasks: Number(data.concurrentTasks ?? 0),","context":" 87:     return {\n 88:       userId: String(data.userId),\n>89:       concurrentTasks: Number(data.concurrentTasks ?? 0),\n 90:       tasksThisHour: Number(data.tasksThisHour ?? 0),\n 91:       hourStartedAt: toTimestamp(data.hourStartedAt),"},{"type":"typecheck","code":"TS4111","file":"apps/code-agent/src/infra/firestore/userUsageFirestoreRepository.ts","line":90,"message":"Property 'tasksThisHour' comes from an index signature, so it must be accessed with ['tasksThisHour'].","snippet":"tasksThisHour: Number(data.tasksThisHour ?? 0),","context":" 88:       userId: String(data.userId),\n 89:       concurrentTasks: Number(data.concurrentTasks ?? 0),\n>90:       tasksThisHour: Number(data.tasksThisHour ?? 0),\n 91:       hourStartedAt: toTimestamp(data.hourStartedAt),\n 92:       costToday: Number(data.costToday ?? 0),"},{"type":"typecheck","code":"TS4111","file":"apps/code-agent/src/infra/firestore/userUsageFirestoreRepository.ts","line":91,"message":"Property 'hourStartedAt' comes from an index signature, so it must be accessed with ['hourStartedAt'].","snippet":"hourStartedAt: toTimestamp(data.hourStartedAt),","context":" 89:       concurrentTasks: Number(data.concurrentTasks ?? 0),\n 90:       tasksThisHour: Number(data.tasksThisHour ?? 0),\n>91:       hourStartedAt: toTimestamp(data.hourStartedAt),\n 92:       costToday: Number(data.costToday ?? 0),\n 93:       costThisMonth: Number(data.costThisMonth ?? 0),"},{"type":"typecheck","code":"TS4111","file":"apps/code-agent/src/infra/firestore/userUsageFirestoreRepository.ts","line":92,"message":"Property 'costToday' comes from an index signature, so it must be accessed with ['costToday'].","snippet":"costToday: Number(data.costToday ?? 0),","context":" 90:       tasksThisHour: Number(data.tasksThisHour ?? 0),\n 91:       hourStartedAt: toTimestamp(data.hourStartedAt),\n>92:       costToday: Number(data.costToday ?? 0),\n 93:       costThisMonth: Number(data.costThisMonth ?? 0),\n 94:       dayStartedAt: toTimestamp(data.dayStartedAt),"},{"type":"typecheck","code":"TS4111","file":"apps/code-agent/src/infra/firestore/userUsageFirestoreRepository.ts","line":93,"message":"Property 'costThisMonth' comes from an index signature, so it must be accessed with ['costThisMonth'].","snippet":"costThisMonth: Number(data.costThisMonth ?? 0),","context":" 91:       hourStartedAt: toTimestamp(data.hourStartedAt),\n 92:       costToday: Number(data.costToday ?? 0),\n>93:       costThisMonth: Number(data.costThisMonth ?? 0),\n 94:       dayStartedAt: toTimestamp(data.dayStartedAt),\n 95:       monthStartedAt: toTimestamp(data.monthStartedAt),"},{"type":"typecheck","code":"TS4111","file":"apps/code-agent/src/infra/firestore/userUsageFirestoreRepository.ts","line":94,"message":"Property 'dayStartedAt' comes from an index signature, so it must be accessed with ['dayStartedAt'].","snippet":"dayStartedAt: toTimestamp(data.dayStartedAt),","context":" 92:       costToday: Number(data.costToday ?? 0),\n 93:       costThisMonth: Number(data.costThisMonth ?? 0),\n>94:       dayStartedAt: toTimestamp(data.dayStartedAt),\n 95:       monthStartedAt: toTimestamp(data.monthStartedAt),\n 96:       updatedAt: toTimestamp(data.updatedAt),"},{"type":"typecheck","code":"TS4111","file":"apps/code-agent/src/infra/firestore/userUsageFirestoreRepository.ts","line":95,"message":"Property 'monthStartedAt' comes from an index signature, so it must be accessed with ['monthStartedAt'].","snippet":"monthStartedAt: toTimestamp(data.monthStartedAt),","context":" 93:       costThisMonth: Number(data.costThisMonth ?? 0),\n 94:       dayStartedAt: toTimestamp(data.dayStartedAt),\n>95:       monthStartedAt: toTimestamp(data.monthStartedAt),\n 96:       updatedAt: toTimestamp(data.updatedAt),\n 97:     };"},{"type":"typecheck","code":"TS4111","file":"apps/code-agent/src/infra/firestore/userUsageFirestoreRepository.ts","line":96,"message":"Property 'updatedAt' comes from an index signature, so it must be accessed with ['updatedAt'].","snippet":"updatedAt: toTimestamp(data.updatedAt),","context":" 94:       dayStartedAt: toTimestamp(data.dayStartedAt),\n 95:       monthStartedAt: toTimestamp(data.monthStartedAt),\n>96:       updatedAt: toTimestamp(data.updatedAt),\n 97:     };\n 98:   }"},{"type":"typecheck","code":"TS2339","file":"apps/code-agent/src/routes/codeRoutes.ts","line":670,"message":"Property 'apiCost' does not exist on type '{ branch: string; commits: number; summary: string; prUrl?: string; ciFailed?: boolean; partialWork?: boolean; rebaseResult?: \"success\" | \"skipped\" | \"conflict\"; }'.","snippet":"const actualCost = body.result?.apiCost; // Orchestrator may report actual cost","context":" 668:       if (body.status !== undefined && terminalStatuses.includes(body.status)) {\n 669:         const userId = result.value.userId;\n>670:         const actualCost = body.result?.apiCost; // Orchestrator may report actual cost\n 671:         // Fire and forget - don't await to avoid delaying response\n 672:         rateLimitService.recordTaskComplete(userId, actualCost).catch((err) => {"},{"type":"verify","code":"VERIFY_FAIL","file":"unknown","line":0,"message":"FAILED","snippet":null,"context":null}]}
